// Jest Snapshot v1, https://goo.gl/fbAQLP

exports[`CDK JS ./examples/tmp/WordPress_Multi_AZ.js renders to CFN ./examples/tmp/WordPress_Multi_AZ.json and matches original stack ./examples/WordPress_Multi_AZ.json 1`] = `
Object {
  "AWSTemplateFormatVersion": "2010-09-09",
  "Description": "AWS CloudFormation Sample Template WordPress_Multi_AZ: WordPress is web software you can use to create a beautiful website or blog. This template installs a highly-available, scalable WordPress deployment using a multi-az Amazon RDS database instance for storage. It demonstrates using the AWS CloudFormation bootstrap scripts to deploy WordPress. **WARNING** This template creates an Amazon EC2 instance, an Application Load Balancer and an Amazon RDS database instance. You will be billed for the AWS resources used if you create a stack from this template.",
  "Mappings": Object {
    "AWSInstanceType2Arch": Object {
      "c1.medium": Object {
        "Arch": "HVM64",
      },
      "c1.xlarge": Object {
        "Arch": "HVM64",
      },
      "c3.2xlarge": Object {
        "Arch": "HVM64",
      },
      "c3.4xlarge": Object {
        "Arch": "HVM64",
      },
      "c3.8xlarge": Object {
        "Arch": "HVM64",
      },
      "c3.large": Object {
        "Arch": "HVM64",
      },
      "c3.xlarge": Object {
        "Arch": "HVM64",
      },
      "c4.2xlarge": Object {
        "Arch": "HVM64",
      },
      "c4.4xlarge": Object {
        "Arch": "HVM64",
      },
      "c4.8xlarge": Object {
        "Arch": "HVM64",
      },
      "c4.large": Object {
        "Arch": "HVM64",
      },
      "c4.xlarge": Object {
        "Arch": "HVM64",
      },
      "cc2.8xlarge": Object {
        "Arch": "HVM64",
      },
      "cr1.8xlarge": Object {
        "Arch": "HVM64",
      },
      "d2.2xlarge": Object {
        "Arch": "HVM64",
      },
      "d2.4xlarge": Object {
        "Arch": "HVM64",
      },
      "d2.8xlarge": Object {
        "Arch": "HVM64",
      },
      "d2.xlarge": Object {
        "Arch": "HVM64",
      },
      "g2.2xlarge": Object {
        "Arch": "HVMG2",
      },
      "g2.8xlarge": Object {
        "Arch": "HVMG2",
      },
      "hi1.4xlarge": Object {
        "Arch": "HVM64",
      },
      "hs1.8xlarge": Object {
        "Arch": "HVM64",
      },
      "i2.2xlarge": Object {
        "Arch": "HVM64",
      },
      "i2.4xlarge": Object {
        "Arch": "HVM64",
      },
      "i2.8xlarge": Object {
        "Arch": "HVM64",
      },
      "i2.xlarge": Object {
        "Arch": "HVM64",
      },
      "m1.large": Object {
        "Arch": "HVM64",
      },
      "m1.medium": Object {
        "Arch": "HVM64",
      },
      "m1.small": Object {
        "Arch": "HVM64",
      },
      "m1.xlarge": Object {
        "Arch": "HVM64",
      },
      "m2.2xlarge": Object {
        "Arch": "HVM64",
      },
      "m2.4xlarge": Object {
        "Arch": "HVM64",
      },
      "m2.xlarge": Object {
        "Arch": "HVM64",
      },
      "m3.2xlarge": Object {
        "Arch": "HVM64",
      },
      "m3.large": Object {
        "Arch": "HVM64",
      },
      "m3.medium": Object {
        "Arch": "HVM64",
      },
      "m3.xlarge": Object {
        "Arch": "HVM64",
      },
      "m4.10xlarge": Object {
        "Arch": "HVM64",
      },
      "m4.2xlarge": Object {
        "Arch": "HVM64",
      },
      "m4.4xlarge": Object {
        "Arch": "HVM64",
      },
      "m4.large": Object {
        "Arch": "HVM64",
      },
      "m4.xlarge": Object {
        "Arch": "HVM64",
      },
      "r3.2xlarge": Object {
        "Arch": "HVM64",
      },
      "r3.4xlarge": Object {
        "Arch": "HVM64",
      },
      "r3.8xlarge": Object {
        "Arch": "HVM64",
      },
      "r3.large": Object {
        "Arch": "HVM64",
      },
      "r3.xlarge": Object {
        "Arch": "HVM64",
      },
      "t1.micro": Object {
        "Arch": "HVM64",
      },
      "t2.large": Object {
        "Arch": "HVM64",
      },
      "t2.medium": Object {
        "Arch": "HVM64",
      },
      "t2.micro": Object {
        "Arch": "HVM64",
      },
      "t2.nano": Object {
        "Arch": "HVM64",
      },
      "t2.small": Object {
        "Arch": "HVM64",
      },
    },
    "AWSInstanceType2NATArch": Object {
      "c1.medium": Object {
        "Arch": "NATHVM64",
      },
      "c1.xlarge": Object {
        "Arch": "NATHVM64",
      },
      "c3.2xlarge": Object {
        "Arch": "NATHVM64",
      },
      "c3.4xlarge": Object {
        "Arch": "NATHVM64",
      },
      "c3.8xlarge": Object {
        "Arch": "NATHVM64",
      },
      "c3.large": Object {
        "Arch": "NATHVM64",
      },
      "c3.xlarge": Object {
        "Arch": "NATHVM64",
      },
      "c4.2xlarge": Object {
        "Arch": "NATHVM64",
      },
      "c4.4xlarge": Object {
        "Arch": "NATHVM64",
      },
      "c4.8xlarge": Object {
        "Arch": "NATHVM64",
      },
      "c4.large": Object {
        "Arch": "NATHVM64",
      },
      "c4.xlarge": Object {
        "Arch": "NATHVM64",
      },
      "cc2.8xlarge": Object {
        "Arch": "NATHVM64",
      },
      "cr1.8xlarge": Object {
        "Arch": "NATHVM64",
      },
      "d2.2xlarge": Object {
        "Arch": "NATHVM64",
      },
      "d2.4xlarge": Object {
        "Arch": "NATHVM64",
      },
      "d2.8xlarge": Object {
        "Arch": "NATHVM64",
      },
      "d2.xlarge": Object {
        "Arch": "NATHVM64",
      },
      "g2.2xlarge": Object {
        "Arch": "NATHVMG2",
      },
      "g2.8xlarge": Object {
        "Arch": "NATHVMG2",
      },
      "hi1.4xlarge": Object {
        "Arch": "NATHVM64",
      },
      "hs1.8xlarge": Object {
        "Arch": "NATHVM64",
      },
      "i2.2xlarge": Object {
        "Arch": "NATHVM64",
      },
      "i2.4xlarge": Object {
        "Arch": "NATHVM64",
      },
      "i2.8xlarge": Object {
        "Arch": "NATHVM64",
      },
      "i2.xlarge": Object {
        "Arch": "NATHVM64",
      },
      "m1.large": Object {
        "Arch": "NATHVM64",
      },
      "m1.medium": Object {
        "Arch": "NATHVM64",
      },
      "m1.small": Object {
        "Arch": "NATHVM64",
      },
      "m1.xlarge": Object {
        "Arch": "NATHVM64",
      },
      "m2.2xlarge": Object {
        "Arch": "NATHVM64",
      },
      "m2.4xlarge": Object {
        "Arch": "NATHVM64",
      },
      "m2.xlarge": Object {
        "Arch": "NATHVM64",
      },
      "m3.2xlarge": Object {
        "Arch": "NATHVM64",
      },
      "m3.large": Object {
        "Arch": "NATHVM64",
      },
      "m3.medium": Object {
        "Arch": "NATHVM64",
      },
      "m3.xlarge": Object {
        "Arch": "NATHVM64",
      },
      "m4.10xlarge": Object {
        "Arch": "NATHVM64",
      },
      "m4.2xlarge": Object {
        "Arch": "NATHVM64",
      },
      "m4.4xlarge": Object {
        "Arch": "NATHVM64",
      },
      "m4.large": Object {
        "Arch": "NATHVM64",
      },
      "m4.xlarge": Object {
        "Arch": "NATHVM64",
      },
      "r3.2xlarge": Object {
        "Arch": "NATHVM64",
      },
      "r3.4xlarge": Object {
        "Arch": "NATHVM64",
      },
      "r3.8xlarge": Object {
        "Arch": "NATHVM64",
      },
      "r3.large": Object {
        "Arch": "NATHVM64",
      },
      "r3.xlarge": Object {
        "Arch": "NATHVM64",
      },
      "t1.micro": Object {
        "Arch": "NATHVM64",
      },
      "t2.large": Object {
        "Arch": "NATHVM64",
      },
      "t2.medium": Object {
        "Arch": "NATHVM64",
      },
      "t2.micro": Object {
        "Arch": "NATHVM64",
      },
      "t2.nano": Object {
        "Arch": "NATHVM64",
      },
      "t2.small": Object {
        "Arch": "NATHVM64",
      },
    },
    "AWSRegionArch2AMI": Object {
      "ap-northeast-1": Object {
        "HVM64": "ami-00a5245b4816c38e6",
        "HVMG2": "ami-09d0e0e099ecabba2",
      },
      "ap-northeast-2": Object {
        "HVM64": "ami-00dc207f8ba6dc919",
        "HVMG2": "NOT_SUPPORTED",
      },
      "ap-northeast-3": Object {
        "HVM64": "ami-0b65f69a5c11f3522",
        "HVMG2": "NOT_SUPPORTED",
      },
      "ap-south-1": Object {
        "HVM64": "ami-0ad42f4f66f6c1cc9",
        "HVMG2": "ami-0244c1d42815af84a",
      },
      "ap-southeast-1": Object {
        "HVM64": "ami-05b3bcf7f311194b3",
        "HVMG2": "ami-0e46ce0d6a87dc979",
      },
      "ap-southeast-2": Object {
        "HVM64": "ami-02fd0b06f06d93dfc",
        "HVMG2": "ami-0c0ab057a101d8ff2",
      },
      "ca-central-1": Object {
        "HVM64": "ami-07423fb63ea0a0930",
        "HVMG2": "NOT_SUPPORTED",
      },
      "cn-north-1": Object {
        "HVM64": "ami-053617c9d818c1189",
        "HVMG2": "NOT_SUPPORTED",
      },
      "cn-northwest-1": Object {
        "HVM64": "ami-0f7937761741dc640",
        "HVMG2": "NOT_SUPPORTED",
      },
      "eu-central-1": Object {
        "HVM64": "ami-0cfbf4f6db41068ac",
        "HVMG2": "ami-0aa1822e3eb913a11",
      },
      "eu-north-1": Object {
        "HVM64": "ami-86fe70f8",
        "HVMG2": "ami-32d55b4c",
      },
      "eu-west-1": Object {
        "HVM64": "ami-08935252a36e25f85",
        "HVMG2": "ami-0d5299b1c6112c3c7",
      },
      "eu-west-2": Object {
        "HVM64": "ami-01419b804382064e4",
        "HVMG2": "NOT_SUPPORTED",
      },
      "eu-west-3": Object {
        "HVM64": "ami-0dd7e7ed60da8fb83",
        "HVMG2": "NOT_SUPPORTED",
      },
      "sa-east-1": Object {
        "HVM64": "ami-05145e0b28ad8e0b2",
        "HVMG2": "NOT_SUPPORTED",
      },
      "us-east-1": Object {
        "HVM64": "ami-0080e4c5bc078760e",
        "HVMG2": "ami-0aeb704d503081ea6",
      },
      "us-east-2": Object {
        "HVM64": "ami-0cd3dfa4e37921605",
        "HVMG2": "NOT_SUPPORTED",
      },
      "us-west-1": Object {
        "HVM64": "ami-0ec6517f6edbf8044",
        "HVMG2": "ami-0a7fc72dc0e51aa77",
      },
      "us-west-2": Object {
        "HVM64": "ami-01e24be29428c15b2",
        "HVMG2": "ami-0fe84a5b4563d8f27",
      },
    },
  },
  "Outputs": Object {
    "WebsiteURL": Object {
      "Description": "WordPress Website",
      "Value": Object {
        "Fn::Join": Array [
          "",
          Array [
            "http://",
            "/wordpress",
          ],
        ],
      },
    },
  },
  "Parameters": Object {
    "DBAllocatedStorage": Object {
      "ConstraintDescription": "must be between 5 and 1024Gb.",
      "Default": "5",
      "Description": "The size of the database (Gb)",
      "MaxValue": "1024",
      "MinValue": "5",
      "Type": "Number",
    },
    "DBClass": Object {
      "AllowedValues": Array [
        "db.t1.micro",
        "db.m1.small",
        "db.m1.medium",
        "db.m1.large",
        "db.m1.xlarge",
        "db.m2.xlarge",
        "db.m2.2xlarge",
        "db.m2.4xlarge",
        "db.m3.medium",
        "db.m3.large",
        "db.m3.xlarge",
        "db.m3.2xlarge",
        "db.m4.large",
        "db.m4.xlarge",
        "db.m4.2xlarge",
        "db.m4.4xlarge",
        "db.m4.10xlarge",
        "db.r3.large",
        "db.r3.xlarge",
        "db.r3.2xlarge",
        "db.r3.4xlarge",
        "db.r3.8xlarge",
        "db.m2.xlarge",
        "db.m2.2xlarge",
        "db.m2.4xlarge",
        "db.cr1.8xlarge",
        "db.t2.micro",
        "db.t2.small",
        "db.t2.medium",
        "db.t2.large",
      ],
      "ConstraintDescription": "must select a valid database instance type.",
      "Default": "db.t2.small",
      "Description": "Database instance class",
      "Type": "String",
    },
    "DBName": Object {
      "AllowedPattern": "[a-zA-Z][a-zA-Z0-9]*",
      "ConstraintDescription": "must begin with a letter and contain only alphanumeric characters.",
      "Default": "wordpressdb",
      "Description": "The WordPress database name",
      "MaxLength": "64",
      "MinLength": "1",
      "Type": "String",
    },
    "DBPassword": Object {
      "AllowedPattern": "[a-zA-Z0-9]*",
      "ConstraintDescription": "must contain only alphanumeric characters.",
      "Description": "The WordPress database admin account password",
      "MaxLength": "41",
      "MinLength": "8",
      "NoEcho": "true",
      "Type": "String",
    },
    "DBUser": Object {
      "AllowedPattern": "[a-zA-Z][a-zA-Z0-9]*",
      "ConstraintDescription": "must begin with a letter and contain only alphanumeric characters.",
      "Description": "The WordPress database admin account username",
      "MaxLength": "16",
      "MinLength": "1",
      "NoEcho": "true",
      "Type": "String",
    },
    "InstanceType": Object {
      "AllowedValues": Array [
        "t1.micro",
        "t2.nano",
        "t2.micro",
        "t2.small",
        "t2.medium",
        "t2.large",
        "m1.small",
        "m1.medium",
        "m1.large",
        "m1.xlarge",
        "m2.xlarge",
        "m2.2xlarge",
        "m2.4xlarge",
        "m3.medium",
        "m3.large",
        "m3.xlarge",
        "m3.2xlarge",
        "m4.large",
        "m4.xlarge",
        "m4.2xlarge",
        "m4.4xlarge",
        "m4.10xlarge",
        "c1.medium",
        "c1.xlarge",
        "c3.large",
        "c3.xlarge",
        "c3.2xlarge",
        "c3.4xlarge",
        "c3.8xlarge",
        "c4.large",
        "c4.xlarge",
        "c4.2xlarge",
        "c4.4xlarge",
        "c4.8xlarge",
        "g2.2xlarge",
        "g2.8xlarge",
        "r3.large",
        "r3.xlarge",
        "r3.2xlarge",
        "r3.4xlarge",
        "r3.8xlarge",
        "i2.xlarge",
        "i2.2xlarge",
        "i2.4xlarge",
        "i2.8xlarge",
        "d2.xlarge",
        "d2.2xlarge",
        "d2.4xlarge",
        "d2.8xlarge",
        "hi1.4xlarge",
        "hs1.8xlarge",
        "cr1.8xlarge",
        "cc2.8xlarge",
        "cg1.4xlarge",
      ],
      "ConstraintDescription": "must be a valid EC2 instance type.",
      "Default": "t2.small",
      "Description": "WebServer EC2 instance type",
      "Type": "String",
    },
    "KeyName": Object {
      "ConstraintDescription": "must be the name of an existing EC2 KeyPair.",
      "Description": "Name of an existing EC2 KeyPair to enable SSH access to the instances",
      "Type": "AWS::EC2::KeyPair::KeyName",
    },
    "MultiAZDatabase": Object {
      "AllowedValues": Array [
        "true",
        "false",
      ],
      "ConstraintDescription": "must be either true or false.",
      "Default": "false",
      "Description": "Create a Multi-AZ MySQL Amazon RDS database instance",
      "Type": "String",
    },
    "SSHLocation": Object {
      "AllowedPattern": "(\\\\d{1,3})\\\\.(\\\\d{1,3})\\\\.(\\\\d{1,3})\\\\.(\\\\d{1,3})/(\\\\d{1,2})",
      "ConstraintDescription": "must be a valid IP CIDR range of the form x.x.x.x/x.",
      "Default": "0.0.0.0/0",
      "Description": "The IP address range that can be used to SSH to the EC2 instances",
      "MaxLength": "18",
      "MinLength": "9",
      "Type": "String",
    },
    "Subnets": Object {
      "ConstraintDescription": "must be a list of at least two existing subnets associated with at least two different availability zones. They should be residing in the selected Virtual Private Cloud.",
      "Description": "The list of SubnetIds in your Virtual Private Cloud (VPC)",
      "Type": "List<AWS::EC2::Subnet::Id>",
    },
    "VpcId": Object {
      "ConstraintDescription": "must be the VPC Id of an existing Virtual Private Cloud.",
      "Description": "VpcId of your existing Virtual Private Cloud (VPC)",
      "Type": "AWS::EC2::VPC::Id",
    },
    "WebServerCapacity": Object {
      "ConstraintDescription": "must be between 1 and 5 EC2 instances.",
      "Default": "1",
      "Description": "The initial number of WebServer instances",
      "MaxValue": "5",
      "MinValue": "1",
      "Type": "Number",
    },
  },
  "Resources": Object {
    "ALBListener": Object {
      "Properties": Object {
        "DefaultActions": Array [
          Object {
            "TargetGroupArn": Object {
              "Ref": "ALBTargetGroup",
            },
            "Type": "forward",
          },
        ],
        "LoadBalancerArn": Object {
          "Ref": "ApplicationLoadBalancer",
        },
        "Port": 80,
        "Protocol": "HTTP",
      },
      "Type": "AWS::ElasticLoadBalancingV2::Listener",
    },
    "ALBTargetGroup": Object {
      "Properties": Object {
        "HealthCheckIntervalSeconds": 10,
        "HealthCheckPath": "/wordpress/wp-admin/install.php",
        "HealthCheckTimeoutSeconds": 5,
        "HealthyThresholdCount": 2,
        "Port": 80,
        "Protocol": "HTTP",
        "TargetGroupAttributes": Array [
          Object {
            "Key": "stickiness.enabled",
            "Value": "true",
          },
          Object {
            "Key": "stickiness.type",
            "Value": "lb_cookie",
          },
          Object {
            "Key": "stickiness.lb_cookie.duration_seconds",
            "Value": "30",
          },
        ],
        "UnhealthyThresholdCount": 5,
        "VpcId": Object {
          "Ref": "VpcId",
        },
      },
      "Type": "AWS::ElasticLoadBalancingV2::TargetGroup",
    },
    "ApplicationLoadBalancer": Object {
      "Properties": Object {
        "Subnets": Object {
          "Ref": "Subnets",
        },
      },
      "Type": "AWS::ElasticLoadBalancingV2::LoadBalancer",
    },
    "DBEC2SecurityGroup": Object {
      "Properties": Object {
        "GroupDescription": "Open database for access",
        "SecurityGroupIngress": Array [
          Object {
            "FromPort": 3306,
            "IpProtocol": "tcp",
            "SourceSecurityGroupId": Object {
              "Ref": "WebServerSecurityGroup",
            },
            "ToPort": 3306,
          },
        ],
        "VpcId": Object {
          "Ref": "VpcId",
        },
      },
      "Type": "AWS::EC2::SecurityGroup",
    },
    "DBInstance": Object {
      "Properties": Object {
        "AllocatedStorage": Object {
          "Ref": "DBAllocatedStorage",
        },
        "DBInstanceClass": Object {
          "Ref": "DBClass",
        },
        "DBName": Object {
          "Ref": "DBName",
        },
        "Engine": "MySQL",
        "MasterUserPassword": Object {
          "Ref": "DBPassword",
        },
        "MasterUsername": Object {
          "Ref": "DBUser",
        },
        "MultiAZ": Object {
          "Ref": "MultiAZDatabase",
        },
        "VPCSecurityGroups": Array [
          Object {
            "Fn::GetAtt": Array [
              "DBEC2SecurityGroup",
              "GroupId",
            ],
          },
        ],
      },
      "Type": "AWS::RDS::DBInstance",
    },
    "LaunchConfig": Object {
      "Metadata": Object {
        "AWS::CloudFormation::Init": Object {
          "configSets": Object {
            "wordpress_install": Array [
              "install_cfn",
              "install_wordpress",
            ],
          },
          "install_cfn": Object {
            "files": Object {
              "/etc/cfn/cfn-hup.conf": Object {
                "content": Object {
                  "Fn::Join": Array [
                    "",
                    Array [
                      "[main]
",
                      "stack=",
                      Object {
                        "Ref": "AWS::StackId",
                      },
                      "
",
                      "region=",
                      Object {
                        "Ref": "AWS::Region",
                      },
                      "
",
                    ],
                  ],
                },
                "group": "root",
                "mode": "000400",
                "owner": "root",
              },
              "/etc/cfn/hooks.d/cfn-auto-reloader.conf": Object {
                "content": Object {
                  "Fn::Join": Array [
                    "",
                    Array [
                      "[cfn-auto-reloader-hook]
",
                      "triggers=post.update
",
                      "path=Resources.LaunchConfig.Metadata.AWS::CloudFormation::Init
",
                      "action=/opt/aws/bin/cfn-init -v ",
                      "         --stack ",
                      Object {
                        "Ref": "AWS::StackName",
                      },
                      "         --resource LaunchConfig ",
                      "         --configsets wordpress_install ",
                      "         --region ",
                      Object {
                        "Ref": "AWS::Region",
                      },
                      "
",
                    ],
                  ],
                },
                "group": "root",
                "mode": "000400",
                "owner": "root",
              },
            },
            "services": Object {
              "sysvinit": Object {
                "cfn-hup": Object {
                  "enabled": "true",
                  "ensureRunning": "true",
                  "files": Array [
                    "/etc/cfn/cfn-hup.conf",
                    "/etc/cfn/hooks.d/cfn-auto-reloader.conf",
                  ],
                },
              },
            },
          },
          "install_wordpress": Object {
            "commands": Object {
              "01_configure_wordpress": Object {
                "command": "/tmp/create-wp-config",
                "cwd": "/var/www/html/wordpress",
              },
            },
            "files": Object {
              "/tmp/create-wp-config": Object {
                "content": Object {
                  "Fn::Join": Array [
                    "",
                    Array [
                      "#!/bin/bash
",
                      "cp /var/www/html/wordpress/wp-config-sample.php /var/www/html/wordpress/wp-config.php
",
                      "sed -i \\"s/'database_name_here'/'",
                      Object {
                        "Ref": "DBName",
                      },
                      "'/g\\" wp-config.php
",
                      "sed -i \\"s/'username_here'/'",
                      Object {
                        "Ref": "DBUser",
                      },
                      "'/g\\" wp-config.php
",
                      "sed -i \\"s/'password_here'/'",
                      Object {
                        "Ref": "DBPassword",
                      },
                      "'/g\\" wp-config.php
",
                      "sed -i \\"s/'localhost'/'",
                      Object {
                        "Fn::GetAtt": Array [
                          "DBInstance",
                          "Endpoint.Address",
                        ],
                      },
                      "'/g\\" wp-config.php
",
                    ],
                  ],
                },
                "group": "root",
                "mode": "000500",
                "owner": "root",
              },
            },
            "packages": Object {
              "yum": Object {
                "httpd": Array [],
                "mysql": Array [],
                "php": Array [],
                "php-mysql": Array [],
              },
            },
            "services": Object {
              "sysvinit": Object {
                "httpd": Object {
                  "enabled": "true",
                  "ensureRunning": "true",
                },
              },
            },
            "sources": Object {
              "/var/www/html": "http://wordpress.org/latest.tar.gz",
            },
          },
        },
      },
      "Properties": Object {
        "ImageId": Object {
          "Fn::FindInMap": Array [
            "AWSRegionArch2AMI",
            Object {
              "Ref": "AWS::Region",
            },
            Object {
              "Fn::FindInMap": Array [
                "AWSInstanceType2Arch",
                Object {
                  "Ref": "InstanceType",
                },
                "Arch",
              ],
            },
          ],
        },
        "InstanceType": Object {
          "Ref": "InstanceType",
        },
        "KeyName": Object {
          "Ref": "KeyName",
        },
        "SecurityGroups": Array [
          Object {
            "Ref": "WebServerSecurityGroup",
          },
        ],
        "UserData": Object {
          "Fn::Base64": Object {
            "Fn::Join": Array [
              "",
              Array [
                "#!/bin/bash -xe
yum update -y aws-cfn-bootstrap
/opt/aws/bin/cfn-init -v          --stack ",
                Object {
                  "Ref": "AWS::StackName",
                },
                "         --resource LaunchConfig          --configsets wordpress_install          --region ",
                Object {
                  "Ref": "AWS::Region",
                },
                "
/opt/aws/bin/cfn-signal -e $?          --stack ",
                Object {
                  "Ref": "AWS::StackName",
                },
                "         --resource WebServerGroup          --region ",
                Object {
                  "Ref": "AWS::Region",
                },
                "
",
              ],
            ],
          },
        },
      },
      "Type": "AWS::AutoScaling::LaunchConfiguration",
    },
    "WebServerGroup": Object {
      "CreationPolicy": Object {
        "ResourceSignal": Object {
          "Timeout": "PT15M",
        },
      },
      "Properties": Object {
        "DesiredCapacity": Object {
          "Ref": "WebServerCapacity",
        },
        "LaunchConfigurationName": Object {
          "Ref": "LaunchConfig",
        },
        "MaxSize": "5",
        "MinSize": "1",
        "VPCZoneIdentifier": Object {
          "Ref": "Subnets",
        },
      },
      "Type": "AWS::AutoScaling::AutoScalingGroup",
      "UpdatePolicy": Object {
        "AutoScalingRollingUpdate": Object {
          "MaxBatchSize": "1",
          "MinInstancesInService": "1",
          "PauseTime": "PT15M",
          "WaitOnResourceSignals": "true",
        },
      },
    },
    "WebServerSecurityGroup": Object {
      "Properties": Object {
        "GroupDescription": "Enable HTTP access via port 80 locked down to the load balancer + SSH access",
        "SecurityGroupIngress": Array [
          Object {
            "FromPort": 80,
            "IpProtocol": "tcp",
            "SourceSecurityGroupId": Object {
              "Fn::Select": Array [
                0,
                Object {
                  "Fn::GetAtt": Array [
                    "ApplicationLoadBalancer",
                    "SecurityGroups",
                  ],
                },
              ],
            },
            "ToPort": 80,
          },
          Object {
            "CidrIp": Object {
              "Ref": "SSHLocation",
            },
            "FromPort": 22,
            "IpProtocol": "tcp",
            "ToPort": 22,
          },
        ],
        "VpcId": Object {
          "Ref": "VpcId",
        },
      },
      "Type": "AWS::EC2::SecurityGroup",
    },
  },
}
`;

exports[`CDK JS ./examples/tmp/buildkiteasg.js renders to CFN ./examples/tmp/buildkiteasg.json and matches original stack ./examples/buildkiteasg.json 1`] = `
Object {
  "Parameters": Object {
    "BuildkiteAgentRelease": Object {
      "AllowedValues": Array [
        "stable",
        "beta",
        "edge",
      ],
      "Default": "stable",
      "Type": "String",
    },
    "BuildkiteQueue": Object {
      "Default": "default",
      "Description": "Queue name that agents will use, targeted in pipeline steps using \\"queue={value}\\"",
      "MinLength": 1,
      "Type": "String",
    },
    "CostAllocationTagName": Object {
      "Default": "aws:createdBy",
      "Description": "The name of the Cost Allocation Tag used for billing purposes",
      "Type": "String",
    },
    "CostAllocationTagValue": Object {
      "Default": "buildkite-elastic-ci-stack-for-aws",
      "Description": "The value of the Cost Allocation Tag used for billing purposes",
      "Type": "String",
    },
    "InstanceCreationTimeout": Object {
      "Default": "PT5M",
      "Description": "Timeout period for Autoscaling Group Creation Policy",
      "Type": "String",
    },
    "MaxSize": Object {
      "Default": 10,
      "Description": "Maximum number of instances",
      "MinValue": 1,
      "Type": "Number",
    },
    "MinSize": Object {
      "Default": 0,
      "Description": "Minimum number of instances",
      "Type": "Number",
    },
    "Subnets": Object {
      "Default": "",
      "Description": "Optional - Comma separated list of two existing VPC subnet ids where EC2 instances will run. Required if setting VpcId.",
      "Type": "CommaDelimitedList",
    },
  },
  "Resources": Object {
    "AgentAutoScaleGroup": Object {
      "CreationPolicy": Object {
        "ResourceSignal": Object {
          "Count": Object {
            "Ref": "MinSize",
          },
          "Timeout": Object {
            "Ref": "InstanceCreationTimeout",
          },
        },
      },
      "Properties": Object {
        "LaunchConfigurationName": Object {
          "Ref": "AgentLaunchConfiguration",
        },
        "MaxSize": Object {
          "Ref": "MaxSize",
        },
        "MetricsCollection": Array [
          Object {
            "Granularity": "1Minute",
            "Metrics": Array [
              "GroupMinSize",
              "GroupMaxSize",
              "GroupInServiceInstances",
              "GroupTerminatingInstances",
              "GroupPendingInstances",
            ],
          },
        ],
        "MinSize": Object {
          "Ref": "MinSize",
        },
        "Tags": Array [
          Object {
            "Key": "Role",
            "PropagateAtLaunch": true,
            "Value": "buildkite-agent",
          },
          Object {
            "Key": "Name",
            "PropagateAtLaunch": true,
            "Value": "buildkite-agent",
          },
          Object {
            "Key": "BuildkiteAgentRelease",
            "PropagateAtLaunch": true,
            "Value": Object {
              "Ref": "BuildkiteAgentRelease",
            },
          },
          Object {
            "Key": "BuildkiteQueue",
            "PropagateAtLaunch": true,
            "Value": Object {
              "Ref": "BuildkiteQueue",
            },
          },
        ],
        "TerminationPolicies": Array [
          "OldestLaunchConfiguration",
          "ClosestToNextInstanceHour",
        ],
        "VPCZoneIdentifier": Array [
          Object {
            "Ref": "Subnets",
          },
        ],
      },
      "Type": "AWS::AutoScaling::AutoScalingGroup",
      "UpdatePolicy": Object {
        "AutoScalingReplacingUpdate": Object {
          "WillReplace": true,
        },
      },
    },
    "AgentLaunchConfiguration": Object {
      "Properties": Object {
        "ImageId": "ami-fff",
        "InstanceType": "m4.large",
      },
      "Type": "AWS::AutoScaling::LaunchConfiguration",
    },
  },
}
`;

exports[`CDK JS ./examples/tmp/cloudtrail.js renders to CFN ./examples/tmp/cloudtrail.json and matches original stack ./examples/cloudtrail.json 1`] = `
Object {
  "Parameters": Object {
    "LoggingBucket": Object {
      "Description": "The name of the bucket to send cloudtrail logs to",
      "Type": "String",
    },
    "Unused": Object {
      "Description": "An unused parameter to test ref checks",
      "Type": "String",
    },
  },
  "Resources": Object {
    "CloudTrail": Object {
      "Properties": Object {
        "IncludeGlobalServiceEvents": true,
        "IsLogging": true,
        "IsMultiRegionTrail": true,
        "S3BucketName": Object {
          "Ref": "LoggingBucket",
        },
        "S3KeyPrefix": "cloudtrails",
      },
      "Type": "AWS::CloudTrail::Trail",
    },
  },
}
`;

exports[`Stack ./examples/WordPress_Multi_AZ.json compiles to ./examples/tmp/WordPress_Multi_AZ.ts 1`] = `
"import * as cdk from \\"@aws-cdk/core\\";
import * as elasticloadbalancingv2 from \\"@aws-cdk/aws-elasticloadbalancingv2\\";
import * as ec2 from \\"@aws-cdk/aws-ec2\\";
import * as autoscaling from \\"@aws-cdk/aws-autoscaling\\";
import * as rds from \\"@aws-cdk/aws-rds\\";

export class WordPressMultiAzStack extends cdk.Stack {
  constructor(parent: cdk.App, id: string, props?: cdk.StackProps) {
    super(parent, id, props);

    this.templateOptions.templateFormatVersion = \\"2010-09-09\\";
    this.templateOptions.description =
      \\"AWS CloudFormation Sample Template WordPress_Multi_AZ: WordPress is web software you can use to create a beautiful website or blog. This template installs a highly-available, scalable WordPress deployment using a multi-az Amazon RDS database instance for storage. It demonstrates using the AWS CloudFormation bootstrap scripts to deploy WordPress. **WARNING** This template creates an Amazon EC2 instance, an Application Load Balancer and an Amazon RDS database instance. You will be billed for the AWS resources used if you create a stack from this template.\\";

    const vpcId = new cdk.CfnParameter(this, \\"VpcId\\", {
      type: \\"AWS::EC2::VPC::Id\\",
      description: \\"VpcId of your existing Virtual Private Cloud (VPC)\\",
      constraintDescription:
        \\"must be the VPC Id of an existing Virtual Private Cloud.\\"
    });

    const subnets = new cdk.CfnParameter(this, \\"Subnets\\", {
      type: \\"List<AWS::EC2::Subnet::Id>\\",
      description: \\"The list of SubnetIds in your Virtual Private Cloud (VPC)\\",
      constraintDescription:
        \\"must be a list of at least two existing subnets associated with at least two different availability zones. They should be residing in the selected Virtual Private Cloud.\\"
    });

    const keyName = new cdk.CfnParameter(this, \\"KeyName\\", {
      description:
        \\"Name of an existing EC2 KeyPair to enable SSH access to the instances\\",
      type: \\"AWS::EC2::KeyPair::KeyName\\",
      constraintDescription: \\"must be the name of an existing EC2 KeyPair.\\"
    });

    const instanceType = new cdk.CfnParameter(this, \\"InstanceType\\", {
      description: \\"WebServer EC2 instance type\\",
      type: \\"String\\",
      default: \\"t2.small\\",
      allowedValues: [
        \\"t1.micro\\",
        \\"t2.nano\\",
        \\"t2.micro\\",
        \\"t2.small\\",
        \\"t2.medium\\",
        \\"t2.large\\",
        \\"m1.small\\",
        \\"m1.medium\\",
        \\"m1.large\\",
        \\"m1.xlarge\\",
        \\"m2.xlarge\\",
        \\"m2.2xlarge\\",
        \\"m2.4xlarge\\",
        \\"m3.medium\\",
        \\"m3.large\\",
        \\"m3.xlarge\\",
        \\"m3.2xlarge\\",
        \\"m4.large\\",
        \\"m4.xlarge\\",
        \\"m4.2xlarge\\",
        \\"m4.4xlarge\\",
        \\"m4.10xlarge\\",
        \\"c1.medium\\",
        \\"c1.xlarge\\",
        \\"c3.large\\",
        \\"c3.xlarge\\",
        \\"c3.2xlarge\\",
        \\"c3.4xlarge\\",
        \\"c3.8xlarge\\",
        \\"c4.large\\",
        \\"c4.xlarge\\",
        \\"c4.2xlarge\\",
        \\"c4.4xlarge\\",
        \\"c4.8xlarge\\",
        \\"g2.2xlarge\\",
        \\"g2.8xlarge\\",
        \\"r3.large\\",
        \\"r3.xlarge\\",
        \\"r3.2xlarge\\",
        \\"r3.4xlarge\\",
        \\"r3.8xlarge\\",
        \\"i2.xlarge\\",
        \\"i2.2xlarge\\",
        \\"i2.4xlarge\\",
        \\"i2.8xlarge\\",
        \\"d2.xlarge\\",
        \\"d2.2xlarge\\",
        \\"d2.4xlarge\\",
        \\"d2.8xlarge\\",
        \\"hi1.4xlarge\\",
        \\"hs1.8xlarge\\",
        \\"cr1.8xlarge\\",
        \\"cc2.8xlarge\\",
        \\"cg1.4xlarge\\"
      ],
      constraintDescription: \\"must be a valid EC2 instance type.\\"
    });

    const sshLocation = new cdk.CfnParameter(this, \\"SSHLocation\\", {
      description:
        \\"The IP address range that can be used to SSH to the EC2 instances\\",
      type: \\"String\\",
      minLength: \\"9\\",
      maxLength: \\"18\\",
      default: \\"0.0.0.0/0\\",
      allowedPattern:
        \\"(\\\\\\\\d{1,3})\\\\\\\\.(\\\\\\\\d{1,3})\\\\\\\\.(\\\\\\\\d{1,3})\\\\\\\\.(\\\\\\\\d{1,3})/(\\\\\\\\d{1,2})\\",
      constraintDescription:
        \\"must be a valid IP CIDR range of the form x.x.x.x/x.\\"
    });

    const dbClass = new cdk.CfnParameter(this, \\"DBClass\\", {
      description: \\"Database instance class\\",
      type: \\"String\\",
      default: \\"db.t2.small\\",
      allowedValues: [
        \\"db.t1.micro\\",
        \\"db.m1.small\\",
        \\"db.m1.medium\\",
        \\"db.m1.large\\",
        \\"db.m1.xlarge\\",
        \\"db.m2.xlarge\\",
        \\"db.m2.2xlarge\\",
        \\"db.m2.4xlarge\\",
        \\"db.m3.medium\\",
        \\"db.m3.large\\",
        \\"db.m3.xlarge\\",
        \\"db.m3.2xlarge\\",
        \\"db.m4.large\\",
        \\"db.m4.xlarge\\",
        \\"db.m4.2xlarge\\",
        \\"db.m4.4xlarge\\",
        \\"db.m4.10xlarge\\",
        \\"db.r3.large\\",
        \\"db.r3.xlarge\\",
        \\"db.r3.2xlarge\\",
        \\"db.r3.4xlarge\\",
        \\"db.r3.8xlarge\\",
        \\"db.m2.xlarge\\",
        \\"db.m2.2xlarge\\",
        \\"db.m2.4xlarge\\",
        \\"db.cr1.8xlarge\\",
        \\"db.t2.micro\\",
        \\"db.t2.small\\",
        \\"db.t2.medium\\",
        \\"db.t2.large\\"
      ],
      constraintDescription: \\"must select a valid database instance type.\\"
    });

    const dbName = new cdk.CfnParameter(this, \\"DBName\\", {
      default: \\"wordpressdb\\",
      description: \\"The WordPress database name\\",
      type: \\"String\\",
      minLength: \\"1\\",
      maxLength: \\"64\\",
      allowedPattern: \\"[a-zA-Z][a-zA-Z0-9]*\\",
      constraintDescription:
        \\"must begin with a letter and contain only alphanumeric characters.\\"
    });

    const dbUser = new cdk.CfnParameter(this, \\"DBUser\\", {
      noEcho: \\"true\\",
      description: \\"The WordPress database admin account username\\",
      type: \\"String\\",
      minLength: \\"1\\",
      maxLength: \\"16\\",
      allowedPattern: \\"[a-zA-Z][a-zA-Z0-9]*\\",
      constraintDescription:
        \\"must begin with a letter and contain only alphanumeric characters.\\"
    });

    const dbPassword = new cdk.CfnParameter(this, \\"DBPassword\\", {
      noEcho: \\"true\\",
      description: \\"The WordPress database admin account password\\",
      type: \\"String\\",
      minLength: \\"8\\",
      maxLength: \\"41\\",
      allowedPattern: \\"[a-zA-Z0-9]*\\",
      constraintDescription: \\"must contain only alphanumeric characters.\\"
    });

    const multiAzDatabase = new cdk.CfnParameter(this, \\"MultiAZDatabase\\", {
      default: \\"false\\",
      description: \\"Create a Multi-AZ MySQL Amazon RDS database instance\\",
      type: \\"String\\",
      allowedValues: [\\"true\\", \\"false\\"],
      constraintDescription: \\"must be either true or false.\\"
    });

    const webServerCapacity = new cdk.CfnParameter(this, \\"WebServerCapacity\\", {
      default: \\"1\\",
      description: \\"The initial number of WebServer instances\\",
      type: \\"Number\\",
      minValue: \\"1\\",
      maxValue: \\"5\\",
      constraintDescription: \\"must be between 1 and 5 EC2 instances.\\"
    });

    const dbAllocatedStorage = new cdk.CfnParameter(
      this,
      \\"DBAllocatedStorage\\",
      {
        default: \\"5\\",
        description: \\"The size of the database (Gb)\\",
        type: \\"Number\\",
        minValue: \\"5\\",
        maxValue: \\"1024\\",
        constraintDescription: \\"must be between 5 and 1024Gb.\\"
      }
    );

    new cdk.CfnMapping(this, \\"AWSInstanceType2Arch\\", {
      mapping: {
        \\"t1.micro\\": { Arch: \\"HVM64\\" },
        \\"t2.nano\\": { Arch: \\"HVM64\\" },
        \\"t2.micro\\": { Arch: \\"HVM64\\" },
        \\"t2.small\\": { Arch: \\"HVM64\\" },
        \\"t2.medium\\": { Arch: \\"HVM64\\" },
        \\"t2.large\\": { Arch: \\"HVM64\\" },
        \\"m1.small\\": { Arch: \\"HVM64\\" },
        \\"m1.medium\\": { Arch: \\"HVM64\\" },
        \\"m1.large\\": { Arch: \\"HVM64\\" },
        \\"m1.xlarge\\": { Arch: \\"HVM64\\" },
        \\"m2.xlarge\\": { Arch: \\"HVM64\\" },
        \\"m2.2xlarge\\": { Arch: \\"HVM64\\" },
        \\"m2.4xlarge\\": { Arch: \\"HVM64\\" },
        \\"m3.medium\\": { Arch: \\"HVM64\\" },
        \\"m3.large\\": { Arch: \\"HVM64\\" },
        \\"m3.xlarge\\": { Arch: \\"HVM64\\" },
        \\"m3.2xlarge\\": { Arch: \\"HVM64\\" },
        \\"m4.large\\": { Arch: \\"HVM64\\" },
        \\"m4.xlarge\\": { Arch: \\"HVM64\\" },
        \\"m4.2xlarge\\": { Arch: \\"HVM64\\" },
        \\"m4.4xlarge\\": { Arch: \\"HVM64\\" },
        \\"m4.10xlarge\\": { Arch: \\"HVM64\\" },
        \\"c1.medium\\": { Arch: \\"HVM64\\" },
        \\"c1.xlarge\\": { Arch: \\"HVM64\\" },
        \\"c3.large\\": { Arch: \\"HVM64\\" },
        \\"c3.xlarge\\": { Arch: \\"HVM64\\" },
        \\"c3.2xlarge\\": { Arch: \\"HVM64\\" },
        \\"c3.4xlarge\\": { Arch: \\"HVM64\\" },
        \\"c3.8xlarge\\": { Arch: \\"HVM64\\" },
        \\"c4.large\\": { Arch: \\"HVM64\\" },
        \\"c4.xlarge\\": { Arch: \\"HVM64\\" },
        \\"c4.2xlarge\\": { Arch: \\"HVM64\\" },
        \\"c4.4xlarge\\": { Arch: \\"HVM64\\" },
        \\"c4.8xlarge\\": { Arch: \\"HVM64\\" },
        \\"g2.2xlarge\\": { Arch: \\"HVMG2\\" },
        \\"g2.8xlarge\\": { Arch: \\"HVMG2\\" },
        \\"r3.large\\": { Arch: \\"HVM64\\" },
        \\"r3.xlarge\\": { Arch: \\"HVM64\\" },
        \\"r3.2xlarge\\": { Arch: \\"HVM64\\" },
        \\"r3.4xlarge\\": { Arch: \\"HVM64\\" },
        \\"r3.8xlarge\\": { Arch: \\"HVM64\\" },
        \\"i2.xlarge\\": { Arch: \\"HVM64\\" },
        \\"i2.2xlarge\\": { Arch: \\"HVM64\\" },
        \\"i2.4xlarge\\": { Arch: \\"HVM64\\" },
        \\"i2.8xlarge\\": { Arch: \\"HVM64\\" },
        \\"d2.xlarge\\": { Arch: \\"HVM64\\" },
        \\"d2.2xlarge\\": { Arch: \\"HVM64\\" },
        \\"d2.4xlarge\\": { Arch: \\"HVM64\\" },
        \\"d2.8xlarge\\": { Arch: \\"HVM64\\" },
        \\"hi1.4xlarge\\": { Arch: \\"HVM64\\" },
        \\"hs1.8xlarge\\": { Arch: \\"HVM64\\" },
        \\"cr1.8xlarge\\": { Arch: \\"HVM64\\" },
        \\"cc2.8xlarge\\": { Arch: \\"HVM64\\" }
      }
    });

    new cdk.CfnMapping(this, \\"AWSInstanceType2NATArch\\", {
      mapping: {
        \\"t1.micro\\": { Arch: \\"NATHVM64\\" },
        \\"t2.nano\\": { Arch: \\"NATHVM64\\" },
        \\"t2.micro\\": { Arch: \\"NATHVM64\\" },
        \\"t2.small\\": { Arch: \\"NATHVM64\\" },
        \\"t2.medium\\": { Arch: \\"NATHVM64\\" },
        \\"t2.large\\": { Arch: \\"NATHVM64\\" },
        \\"m1.small\\": { Arch: \\"NATHVM64\\" },
        \\"m1.medium\\": { Arch: \\"NATHVM64\\" },
        \\"m1.large\\": { Arch: \\"NATHVM64\\" },
        \\"m1.xlarge\\": { Arch: \\"NATHVM64\\" },
        \\"m2.xlarge\\": { Arch: \\"NATHVM64\\" },
        \\"m2.2xlarge\\": { Arch: \\"NATHVM64\\" },
        \\"m2.4xlarge\\": { Arch: \\"NATHVM64\\" },
        \\"m3.medium\\": { Arch: \\"NATHVM64\\" },
        \\"m3.large\\": { Arch: \\"NATHVM64\\" },
        \\"m3.xlarge\\": { Arch: \\"NATHVM64\\" },
        \\"m3.2xlarge\\": { Arch: \\"NATHVM64\\" },
        \\"m4.large\\": { Arch: \\"NATHVM64\\" },
        \\"m4.xlarge\\": { Arch: \\"NATHVM64\\" },
        \\"m4.2xlarge\\": { Arch: \\"NATHVM64\\" },
        \\"m4.4xlarge\\": { Arch: \\"NATHVM64\\" },
        \\"m4.10xlarge\\": { Arch: \\"NATHVM64\\" },
        \\"c1.medium\\": { Arch: \\"NATHVM64\\" },
        \\"c1.xlarge\\": { Arch: \\"NATHVM64\\" },
        \\"c3.large\\": { Arch: \\"NATHVM64\\" },
        \\"c3.xlarge\\": { Arch: \\"NATHVM64\\" },
        \\"c3.2xlarge\\": { Arch: \\"NATHVM64\\" },
        \\"c3.4xlarge\\": { Arch: \\"NATHVM64\\" },
        \\"c3.8xlarge\\": { Arch: \\"NATHVM64\\" },
        \\"c4.large\\": { Arch: \\"NATHVM64\\" },
        \\"c4.xlarge\\": { Arch: \\"NATHVM64\\" },
        \\"c4.2xlarge\\": { Arch: \\"NATHVM64\\" },
        \\"c4.4xlarge\\": { Arch: \\"NATHVM64\\" },
        \\"c4.8xlarge\\": { Arch: \\"NATHVM64\\" },
        \\"g2.2xlarge\\": { Arch: \\"NATHVMG2\\" },
        \\"g2.8xlarge\\": { Arch: \\"NATHVMG2\\" },
        \\"r3.large\\": { Arch: \\"NATHVM64\\" },
        \\"r3.xlarge\\": { Arch: \\"NATHVM64\\" },
        \\"r3.2xlarge\\": { Arch: \\"NATHVM64\\" },
        \\"r3.4xlarge\\": { Arch: \\"NATHVM64\\" },
        \\"r3.8xlarge\\": { Arch: \\"NATHVM64\\" },
        \\"i2.xlarge\\": { Arch: \\"NATHVM64\\" },
        \\"i2.2xlarge\\": { Arch: \\"NATHVM64\\" },
        \\"i2.4xlarge\\": { Arch: \\"NATHVM64\\" },
        \\"i2.8xlarge\\": { Arch: \\"NATHVM64\\" },
        \\"d2.xlarge\\": { Arch: \\"NATHVM64\\" },
        \\"d2.2xlarge\\": { Arch: \\"NATHVM64\\" },
        \\"d2.4xlarge\\": { Arch: \\"NATHVM64\\" },
        \\"d2.8xlarge\\": { Arch: \\"NATHVM64\\" },
        \\"hi1.4xlarge\\": { Arch: \\"NATHVM64\\" },
        \\"hs1.8xlarge\\": { Arch: \\"NATHVM64\\" },
        \\"cr1.8xlarge\\": { Arch: \\"NATHVM64\\" },
        \\"cc2.8xlarge\\": { Arch: \\"NATHVM64\\" }
      }
    });

    new cdk.CfnMapping(this, \\"AWSRegionArch2AMI\\", {
      mapping: {
        \\"us-east-1\\": {
          HVM64: \\"ami-0080e4c5bc078760e\\",
          HVMG2: \\"ami-0aeb704d503081ea6\\"
        },
        \\"us-west-2\\": {
          HVM64: \\"ami-01e24be29428c15b2\\",
          HVMG2: \\"ami-0fe84a5b4563d8f27\\"
        },
        \\"us-west-1\\": {
          HVM64: \\"ami-0ec6517f6edbf8044\\",
          HVMG2: \\"ami-0a7fc72dc0e51aa77\\"
        },
        \\"eu-west-1\\": {
          HVM64: \\"ami-08935252a36e25f85\\",
          HVMG2: \\"ami-0d5299b1c6112c3c7\\"
        },
        \\"eu-west-2\\": { HVM64: \\"ami-01419b804382064e4\\", HVMG2: \\"NOT_SUPPORTED\\" },
        \\"eu-west-3\\": { HVM64: \\"ami-0dd7e7ed60da8fb83\\", HVMG2: \\"NOT_SUPPORTED\\" },
        \\"eu-central-1\\": {
          HVM64: \\"ami-0cfbf4f6db41068ac\\",
          HVMG2: \\"ami-0aa1822e3eb913a11\\"
        },
        \\"eu-north-1\\": { HVM64: \\"ami-86fe70f8\\", HVMG2: \\"ami-32d55b4c\\" },
        \\"ap-northeast-1\\": {
          HVM64: \\"ami-00a5245b4816c38e6\\",
          HVMG2: \\"ami-09d0e0e099ecabba2\\"
        },
        \\"ap-northeast-2\\": {
          HVM64: \\"ami-00dc207f8ba6dc919\\",
          HVMG2: \\"NOT_SUPPORTED\\"
        },
        \\"ap-northeast-3\\": {
          HVM64: \\"ami-0b65f69a5c11f3522\\",
          HVMG2: \\"NOT_SUPPORTED\\"
        },
        \\"ap-southeast-1\\": {
          HVM64: \\"ami-05b3bcf7f311194b3\\",
          HVMG2: \\"ami-0e46ce0d6a87dc979\\"
        },
        \\"ap-southeast-2\\": {
          HVM64: \\"ami-02fd0b06f06d93dfc\\",
          HVMG2: \\"ami-0c0ab057a101d8ff2\\"
        },
        \\"ap-south-1\\": {
          HVM64: \\"ami-0ad42f4f66f6c1cc9\\",
          HVMG2: \\"ami-0244c1d42815af84a\\"
        },
        \\"us-east-2\\": { HVM64: \\"ami-0cd3dfa4e37921605\\", HVMG2: \\"NOT_SUPPORTED\\" },
        \\"ca-central-1\\": {
          HVM64: \\"ami-07423fb63ea0a0930\\",
          HVMG2: \\"NOT_SUPPORTED\\"
        },
        \\"sa-east-1\\": { HVM64: \\"ami-05145e0b28ad8e0b2\\", HVMG2: \\"NOT_SUPPORTED\\" },
        \\"cn-north-1\\": {
          HVM64: \\"ami-053617c9d818c1189\\",
          HVMG2: \\"NOT_SUPPORTED\\"
        },
        \\"cn-northwest-1\\": {
          HVM64: \\"ami-0f7937761741dc640\\",
          HVMG2: \\"NOT_SUPPORTED\\"
        }
      }
    });

    const applicationLoadBalancer = new elasticloadbalancingv2.CfnLoadBalancer(
      this,
      \\"ApplicationLoadBalancer\\",
      { subnets: subnets.value as any }
    );

    const webServerSecurityGroup = new ec2.CfnSecurityGroup(
      this,
      \\"WebServerSecurityGroup\\",
      {
        groupDescription:
          \\"Enable HTTP access via port 80 locked down to the load balancer + SSH access\\",
        securityGroupIngress: [
          {
            ipProtocol: \\"tcp\\",
            fromPort: 80,
            toPort: 80,
            sourceSecurityGroupId: cdk.Fn.select(
              0,
              applicationLoadBalancer.attrSecurityGroups
            )
          },
          {
            ipProtocol: \\"tcp\\",
            fromPort: 22,
            toPort: 22,
            cidrIp: sshLocation.value as any
          }
        ],
        vpcId: vpcId.value as any
      }
    );

    const dbec2SecurityGroup = new ec2.CfnSecurityGroup(
      this,
      \\"DBEC2SecurityGroup\\",
      {
        groupDescription: \\"Open database for access\\",
        securityGroupIngress: [
          {
            ipProtocol: \\"tcp\\",
            fromPort: 3306,
            toPort: 3306,
            sourceSecurityGroupId: webServerSecurityGroup.ref
          }
        ],
        vpcId: vpcId.value as any
      }
    );

    const dbInstance = new rds.CfnDBInstance(this, \\"DBInstance\\", {
      dbName: dbName.value as any,
      engine: \\"MySQL\\",
      multiAz: multiAzDatabase.value as any,
      masterUsername: dbUser.value as any,
      masterUserPassword: dbPassword.value as any,
      dbInstanceClass: dbClass.value as any,
      allocatedStorage: dbAllocatedStorage.value as any,
      vpcSecurityGroups: [dbec2SecurityGroup.attrGroupId]
    });

    const launchConfig = new autoscaling.CfnLaunchConfiguration(
      this,
      \\"LaunchConfig\\",
      {
        imageId: cdk.Fn.findInMap(
          \\"AWSRegionArch2AMI\\",
          cdk.Aws.REGION,
          cdk.Fn.findInMap(
            \\"AWSInstanceType2Arch\\",
            instanceType.value as any,
            \\"Arch\\"
          )
        ),
        instanceType: instanceType.value as any,
        securityGroups: [webServerSecurityGroup.ref],
        keyName: keyName.value as any,
        userData: cdk.Fn.base64(
          cdk.Fn.join(\\"\\", [
            \\"#!/bin/bash -xe\\\\n\\",
            \\"yum update -y aws-cfn-bootstrap\\\\n\\",
            \\"/opt/aws/bin/cfn-init -v \\",
            \\"         --stack \\",
            cdk.Aws.STACK_NAME,
            \\"         --resource LaunchConfig \\",
            \\"         --configsets wordpress_install \\",
            \\"         --region \\",
            cdk.Aws.REGION,
            \\"\\\\n\\",
            \\"/opt/aws/bin/cfn-signal -e $? \\",
            \\"         --stack \\",
            cdk.Aws.STACK_NAME,
            \\"         --resource WebServerGroup \\",
            \\"         --region \\",
            cdk.Aws.REGION,
            \\"\\\\n\\"
          ])
        )
      }
    );
    launchConfig.cfnOptions.metadata = {
      \\"AWS::CloudFormation::Init\\": {
        configSets: { wordpress_install: [\\"install_cfn\\", \\"install_wordpress\\"] },
        install_cfn: {
          files: {
            \\"/etc/cfn/cfn-hup.conf\\": {
              content: {
                \\"Fn::Join\\": [
                  \\"\\",
                  [
                    \\"[main]\\\\n\\",
                    \\"stack=\\",
                    { Ref: \\"AWS::StackId\\" },
                    \\"\\\\n\\",
                    \\"region=\\",
                    { Ref: \\"AWS::Region\\" },
                    \\"\\\\n\\"
                  ]
                ]
              },
              mode: \\"000400\\",
              owner: \\"root\\",
              group: \\"root\\"
            },
            \\"/etc/cfn/hooks.d/cfn-auto-reloader.conf\\": {
              content: {
                \\"Fn::Join\\": [
                  \\"\\",
                  [
                    \\"[cfn-auto-reloader-hook]\\\\n\\",
                    \\"triggers=post.update\\\\n\\",
                    \\"path=Resources.LaunchConfig.Metadata.AWS::CloudFormation::Init\\\\n\\",
                    \\"action=/opt/aws/bin/cfn-init -v \\",
                    \\"         --stack \\",
                    { Ref: \\"AWS::StackName\\" },
                    \\"         --resource LaunchConfig \\",
                    \\"         --configsets wordpress_install \\",
                    \\"         --region \\",
                    { Ref: \\"AWS::Region\\" },
                    \\"\\\\n\\"
                  ]
                ]
              },
              mode: \\"000400\\",
              owner: \\"root\\",
              group: \\"root\\"
            }
          },
          services: {
            sysvinit: {
              \\"cfn-hup\\": {
                enabled: \\"true\\",
                ensureRunning: \\"true\\",
                files: [
                  \\"/etc/cfn/cfn-hup.conf\\",
                  \\"/etc/cfn/hooks.d/cfn-auto-reloader.conf\\"
                ]
              }
            }
          }
        },
        install_wordpress: {
          packages: { yum: { php: [], \\"php-mysql\\": [], mysql: [], httpd: [] } },
          sources: { \\"/var/www/html\\": \\"http://wordpress.org/latest.tar.gz\\" },
          files: {
            \\"/tmp/create-wp-config\\": {
              content: {
                \\"Fn::Join\\": [
                  \\"\\",
                  [
                    \\"#!/bin/bash\\\\n\\",
                    \\"cp /var/www/html/wordpress/wp-config-sample.php /var/www/html/wordpress/wp-config.php\\\\n\\",
                    \\"sed -i \\\\\\"s/'database_name_here'/'\\",
                    { Ref: \\"DBName\\" },
                    \\"'/g\\\\\\" wp-config.php\\\\n\\",
                    \\"sed -i \\\\\\"s/'username_here'/'\\",
                    { Ref: \\"DBUser\\" },
                    \\"'/g\\\\\\" wp-config.php\\\\n\\",
                    \\"sed -i \\\\\\"s/'password_here'/'\\",
                    { Ref: \\"DBPassword\\" },
                    \\"'/g\\\\\\" wp-config.php\\\\n\\",
                    \\"sed -i \\\\\\"s/'localhost'/'\\",
                    { \\"Fn::GetAtt\\": [\\"DBInstance\\", \\"Endpoint.Address\\"] },
                    \\"'/g\\\\\\" wp-config.php\\\\n\\"
                  ]
                ]
              },
              mode: \\"000500\\",
              owner: \\"root\\",
              group: \\"root\\"
            }
          },
          commands: {
            \\"01_configure_wordpress\\": {
              command: \\"/tmp/create-wp-config\\",
              cwd: \\"/var/www/html/wordpress\\"
            }
          },
          services: {
            sysvinit: { httpd: { enabled: \\"true\\", ensureRunning: \\"true\\" } }
          }
        }
      }
    };

    const albTargetGroup = new elasticloadbalancingv2.CfnTargetGroup(
      this,
      \\"ALBTargetGroup\\",
      {
        healthCheckPath: \\"/wordpress/wp-admin/install.php\\",
        healthCheckIntervalSeconds: 10,
        healthCheckTimeoutSeconds: 5,
        healthyThresholdCount: 2,
        port: 80,
        protocol: \\"HTTP\\",
        unhealthyThresholdCount: 5,
        vpcId: vpcId.value as any,
        targetGroupAttributes: [
          { key: \\"stickiness.enabled\\", value: \\"true\\" },
          { key: \\"stickiness.type\\", value: \\"lb_cookie\\" },
          { key: \\"stickiness.lb_cookie.duration_seconds\\", value: \\"30\\" }
        ]
      }
    );

    const webServerGroup = new autoscaling.CfnAutoScalingGroup(
      this,
      \\"WebServerGroup\\",
      {
        vpcZoneIdentifier: subnets.value as any,
        launchConfigurationName: launchConfig.ref,
        minSize: \\"1\\",
        maxSize: \\"5\\",
        desiredCapacity: webServerCapacity.value as any,
        targetGroupArNs: [albTargetGroup.ref]
      }
    );
    webServerGroup.cfnOptions.creationPolicy = {
      resourceSignal: { timeout: \\"PT15M\\" }
    };
    webServerGroup.cfnOptions.updatePolicy = {
      autoScalingRollingUpdate: {
        minInstancesInService: \\"1\\",
        maxBatchSize: \\"1\\",
        pauseTime: \\"PT15M\\",
        waitOnResourceSignals: \\"true\\"
      }
    };

    const albListener = new elasticloadbalancingv2.CfnListener(
      this,
      \\"ALBListener\\",
      {
        defaultActions: [
          { type: \\"forward\\", targetGroupArn: albTargetGroup.ref }
        ],
        loadBalancerArn: applicationLoadBalancer.ref,
        port: 80,
        protocol: \\"HTTP\\"
      }
    );

    new cdk.CfnOutput(this, \\"WebsiteURL\\", {
      value: cdk.Fn.join(\\"\\", [
        \\"http://\\",
        applicationLoadBalancer.attrDNSName,
        \\"/wordpress\\"
      ]),
      description: \\"WordPress Website\\"
    });
  }
}
"
`;

exports[`Stack ./examples/buildkite.json compiles to ./examples/tmp/buildkite.ts 1`] = `
"import * as cdk from \\"@aws-cdk/core\\";
import * as ec2 from \\"@aws-cdk/aws-ec2\\";
import * as iam from \\"@aws-cdk/aws-iam\\";
import * as s3 from \\"@aws-cdk/aws-s3\\";
import * as autoscaling from \\"@aws-cdk/aws-autoscaling\\";
import * as sns from \\"@aws-cdk/aws-sns\\";
import * as cloudwatch from \\"@aws-cdk/aws-cloudwatch\\";
import * as lambda from \\"@aws-cdk/aws-lambda\\";
import * as events from \\"@aws-cdk/aws-events\\";

export class BuildkiteStack extends cdk.Stack {
  constructor(parent: cdk.App, id: string, props?: cdk.StackProps) {
    super(parent, id, props);

    this.templateOptions.templateFormatVersion = \\"2010-09-09\\";
    this.templateOptions.description = \\"Buildkite stack v4.0.2\\";
    this.templateOptions.metadata = {
      \\"AWS::CloudFormation::Interface\\": {
        ParameterGroups: [
          {
            Label: { default: \\"Buildkite Configuration\\" },
            Parameters: [\\"BuildkiteAgentToken\\", \\"BuildkiteQueue\\"]
          },
          {
            Label: { default: \\"Advanced Buildkite Configuration\\" },
            Parameters: [
              \\"BuildkiteAgentRelease\\",
              \\"BuildkiteAgentTags\\",
              \\"BuildkiteAgentTimestampLines\\",
              \\"BuildkiteAgentExperiments\\"
            ]
          },
          {
            Label: { default: \\"Network Configuration\\" },
            Parameters: [
              \\"VpcId\\",
              \\"Subnets\\",
              \\"AvailabilityZones\\",
              \\"SecurityGroupId\\",
              \\"AssociatePublicIpAddress\\"
            ]
          },
          {
            Label: { default: \\"Instance Configuration\\" },
            Parameters: [
              \\"ImageId\\",
              \\"InstanceType\\",
              \\"AgentsPerInstance\\",
              \\"KeyName\\",
              \\"SpotPrice\\",
              \\"SecretsBucket\\",
              \\"ArtifactsBucket\\",
              \\"AuthorizedUsersUrl\\",
              \\"BootstrapScriptUrl\\",
              \\"RootVolumeSize\\",
              \\"ManagedPolicyARN\\",
              \\"InstanceRoleName\\"
            ]
          },
          {
            Label: { default: \\"Auto-scaling Configuration\\" },
            Parameters: [
              \\"MinSize\\",
              \\"MaxSize\\",
              \\"ScaleUpAdjustment\\",
              \\"ScaleDownAdjustment\\",
              \\"ScaleDownPeriod\\",
              \\"InstanceCreationTimeout\\"
            ]
          },
          {
            Label: { default: \\"Cost Allocation Configuration\\" },
            Parameters: [
              \\"EnableCostAllocationTags\\",
              \\"CostAllocationTagName\\",
              \\"CostAllocationTagValue\\"
            ]
          },
          {
            Label: { default: \\"Docker Daemon Configuration\\" },
            Parameters: [
              \\"EnableDockerUserNamespaceRemap\\",
              \\"EnableDockerExperimental\\"
            ]
          },
          {
            Label: { default: \\"Docker Registry Configuration\\" },
            Parameters: [\\"ECRAccessPolicy\\"]
          },
          {
            Label: { default: \\"Plugin Configuration\\" },
            Parameters: [
              \\"EnableSecretsPlugin\\",
              \\"EnableECRPlugin\\",
              \\"EnableDockerLoginPlugin\\"
            ]
          }
        ]
      }
    };

    const keyName = new cdk.CfnParameter(this, \\"KeyName\\", {
      description:
        \\"Optional - SSH keypair used to access the buildkite instances, setting this will enable SSH ingress\\",
      type: \\"String\\",
      default: \\"\\"
    });

    const buildkiteAgentRelease = new cdk.CfnParameter(
      this,
      \\"BuildkiteAgentRelease\\",
      {
        type: \\"String\\",
        allowedValues: [\\"stable\\", \\"beta\\", \\"edge\\"],
        default: \\"stable\\"
      }
    );

    const buildkiteAgentToken = new cdk.CfnParameter(
      this,
      \\"BuildkiteAgentToken\\",
      {
        description: \\"Buildkite agent registration token\\",
        type: \\"String\\",
        noEcho: true,
        minLength: 1
      }
    );

    const buildkiteAgentTags = new cdk.CfnParameter(
      this,
      \\"BuildkiteAgentTags\\",
      {
        description:
          \\"Additional tags seperated by commas to provide to the agent. E.g os=linux,llamas=always\\",
        type: \\"String\\",
        default: \\"\\"
      }
    );

    const buildkiteAgentTimestampLines = new cdk.CfnParameter(
      this,
      \\"BuildkiteAgentTimestampLines\\",
      {
        description:
          \\"Set to true to prepend timestamps to every line of output\\",
        type: \\"String\\",
        allowedValues: [\\"true\\", \\"false\\"],
        default: \\"false\\"
      }
    );

    const buildkiteAgentExperiments = new cdk.CfnParameter(
      this,
      \\"BuildkiteAgentExperiments\\",
      {
        description:
          \\"Agent experiments to enable, comma delimited. See https://github.com/buildkite/agent/blob/master/EXPERIMENTS.md.\\",
        type: \\"String\\",
        default: \\"\\"
      }
    );

    const buildkiteQueue = new cdk.CfnParameter(this, \\"BuildkiteQueue\\", {
      description:
        'Queue name that agents will use, targeted in pipeline steps using \\"queue={value}\\"',
      type: \\"String\\",
      default: \\"default\\",
      minLength: 1
    });

    const agentsPerInstance = new cdk.CfnParameter(this, \\"AgentsPerInstance\\", {
      description: \\"Number of Buildkite agents to run on each instance\\",
      type: \\"Number\\",
      default: 1,
      minValue: 1
    });

    const secretsBucket = new cdk.CfnParameter(this, \\"SecretsBucket\\", {
      description:
        \\"Optional - Name of an existing S3 bucket containing pipeline secrets (Created if left blank)\\",
      type: \\"String\\",
      default: \\"\\"
    });

    const artifactsBucket = new cdk.CfnParameter(this, \\"ArtifactsBucket\\", {
      description:
        \\"Optional - Name of an existing S3 bucket for build artifact storage\\",
      type: \\"String\\",
      default: \\"\\"
    });

    const bootstrapScriptUrl = new cdk.CfnParameter(
      this,
      \\"BootstrapScriptUrl\\",
      {
        description:
          \\"Optional - HTTPS or S3 URL to run on each instance during boot\\",
        type: \\"String\\",
        default: \\"\\"
      }
    );

    const authorizedUsersUrl = new cdk.CfnParameter(
      this,
      \\"AuthorizedUsersUrl\\",
      {
        description:
          \\"Optional - HTTPS or S3 URL to periodically download ssh authorized_keys from, setting this will enable SSH ingress\\",
        type: \\"String\\",
        default: \\"\\"
      }
    );

    const vpcId = new cdk.CfnParameter(this, \\"VpcId\\", {
      type: \\"String\\",
      description:
        \\"Optional - Id of an existing VPC to launch instances into. Leave blank to have a new VPC created\\",
      default: \\"\\"
    });

    const subnets = new cdk.CfnParameter(this, \\"Subnets\\", {
      type: \\"CommaDelimitedList\\",
      description:
        \\"Optional - Comma separated list of two existing VPC subnet ids where EC2 instances will run. Required if setting VpcId.\\",
      default: \\"\\"
    });

    const availabilityZones = new cdk.CfnParameter(this, \\"AvailabilityZones\\", {
      type: \\"CommaDelimitedList\\",
      description:
        \\"Optional - Comma separated list of AZs that subnets are created in (if Subnets parameter is not specified)\\",
      default: \\"\\"
    });

    const instanceType = new cdk.CfnParameter(this, \\"InstanceType\\", {
      description: \\"Instance type\\",
      type: \\"String\\",
      default: \\"t2.nano\\",
      minLength: 1
    });

    const spotPrice = new cdk.CfnParameter(this, \\"SpotPrice\\", {
      description:
        \\"Spot bid price to use for the instances. 0 means normal (non-spot) instances\\",
      type: \\"String\\",
      default: 0
    });

    const maxSize = new cdk.CfnParameter(this, \\"MaxSize\\", {
      description: \\"Maximum number of instances\\",
      type: \\"Number\\",
      default: 10,
      minValue: 1
    });

    const minSize = new cdk.CfnParameter(this, \\"MinSize\\", {
      description: \\"Minimum number of instances\\",
      type: \\"Number\\",
      default: 0
    });

    const scaleUpAdjustment = new cdk.CfnParameter(this, \\"ScaleUpAdjustment\\", {
      description:
        \\"Number of instances to add on scale up events (ScheduledJobsCount > 0 for 1 min)\\",
      type: \\"Number\\",
      default: 5,
      minValue: 0
    });

    const scaleDownAdjustment = new cdk.CfnParameter(
      this,
      \\"ScaleDownAdjustment\\",
      {
        description:
          \\"Number of instances to remove on scale down events (UnfinishedJobs == 0 for ScaleDownPeriod)\\",
        type: \\"Number\\",
        default: -1,
        maxValue: 0
      }
    );

    const scaleDownPeriod = new cdk.CfnParameter(this, \\"ScaleDownPeriod\\", {
      description:
        \\"Number of seconds UnfinishedJobs must equal 0 before scale down\\",
      type: \\"Number\\",
      default: 1800
    });

    const instanceCreationTimeout = new cdk.CfnParameter(
      this,
      \\"InstanceCreationTimeout\\",
      {
        description: \\"Timeout period for Autoscaling Group Creation Policy\\",
        type: \\"String\\",
        default: \\"PT5M\\"
      }
    );

    const rootVolumeSize = new cdk.CfnParameter(this, \\"RootVolumeSize\\", {
      description: \\"Size of each instance's root EBS volume (in GB)\\",
      type: \\"Number\\",
      default: 250,
      minValue: 10
    });

    const securityGroupId = new cdk.CfnParameter(this, \\"SecurityGroupId\\", {
      type: \\"String\\",
      description: \\"Optional - Security group id to assign to instances\\",
      default: \\"\\"
    });

    const imageId = new cdk.CfnParameter(this, \\"ImageId\\", {
      type: \\"String\\",
      description:
        \\"Optional - Custom AMI to use for instances (must be based on the stack's AMI)\\",
      default: \\"\\"
    });

    const managedPolicyArn = new cdk.CfnParameter(this, \\"ManagedPolicyARN\\", {
      type: \\"CommaDelimitedList\\",
      description:
        \\"Optional - Comma separated list of managed IAM policy ARNs to attach to the instance role\\",
      default: \\"\\"
    });

    const instanceRoleName = new cdk.CfnParameter(this, \\"InstanceRoleName\\", {
      type: \\"String\\",
      description:
        \\"Optional - A name for the IAM Role attached to the Instance Profile\\",
      default: \\"\\"
    });

    const ecrAccessPolicy = new cdk.CfnParameter(this, \\"ECRAccessPolicy\\", {
      type: \\"String\\",
      description: \\"ECR access policy to give container instances\\",
      allowedValues: [\\"none\\", \\"readonly\\", \\"poweruser\\", \\"full\\"],
      default: \\"none\\"
    });

    const associatePublicIpAddress = new cdk.CfnParameter(
      this,
      \\"AssociatePublicIpAddress\\",
      {
        type: \\"String\\",
        description: \\"Associate instances with public IP addresses\\",
        allowedValues: [\\"true\\", \\"false\\"],
        default: \\"true\\"
      }
    );

    const enableSecretsPlugin = new cdk.CfnParameter(
      this,
      \\"EnableSecretsPlugin\\",
      {
        type: \\"String\\",
        description: \\"Enables s3-secrets plugin for all pipelines\\",
        allowedValues: [\\"true\\", \\"false\\"],
        default: \\"true\\"
      }
    );

    const enableEcrPlugin = new cdk.CfnParameter(this, \\"EnableECRPlugin\\", {
      type: \\"String\\",
      description: \\"Enables ecr plugin for all pipelines\\",
      allowedValues: [\\"true\\", \\"false\\"],
      default: \\"true\\"
    });

    const enableDockerLoginPlugin = new cdk.CfnParameter(
      this,
      \\"EnableDockerLoginPlugin\\",
      {
        type: \\"String\\",
        description: \\"Enables docker-login plugin for all pipelines\\",
        allowedValues: [\\"true\\", \\"false\\"],
        default: \\"true\\"
      }
    );

    const enableDockerUserNamespaceRemap = new cdk.CfnParameter(
      this,
      \\"EnableDockerUserNamespaceRemap\\",
      {
        type: \\"String\\",
        description:
          \\"Enables Docker user namespace remapping so docker runs as buildkite-agent\\",
        allowedValues: [\\"true\\", \\"false\\"],
        default: \\"true\\"
      }
    );

    const enableDockerExperimental = new cdk.CfnParameter(
      this,
      \\"EnableDockerExperimental\\",
      {
        type: \\"String\\",
        description: \\"Enables Docker experimental features\\",
        allowedValues: [\\"true\\", \\"false\\"],
        default: \\"false\\"
      }
    );

    const enableCostAllocationTags = new cdk.CfnParameter(
      this,
      \\"EnableCostAllocationTags\\",
      {
        type: \\"String\\",
        description:
          \\"Enables AWS Cost Allocation tags for all resources in the stack. See https://docs.aws.amazon.com/awsaccountbilling/latest/aboutv2/cost-alloc-tags.html\\",
        allowedValues: [\\"true\\", \\"false\\"],
        default: \\"false\\"
      }
    );

    const costAllocationTagName = new cdk.CfnParameter(
      this,
      \\"CostAllocationTagName\\",
      {
        type: \\"String\\",
        description:
          \\"The name of the Cost Allocation Tag used for billing purposes\\",
        default: \\"aws:createdBy\\"
      }
    );

    const costAllocationTagValue = new cdk.CfnParameter(
      this,
      \\"CostAllocationTagValue\\",
      {
        type: \\"String\\",
        description:
          \\"The value of the Cost Allocation Tag used for billing purposes\\",
        default: \\"buildkite-elastic-ci-stack-for-aws\\"
      }
    );

    new cdk.CfnMapping(this, \\"ECRManagedPolicy\\", {
      mapping: {
        none: { Policy: \\"\\" },
        readonly: {
          Policy: \\"arn:aws:iam::aws:policy/AmazonEC2ContainerRegistryReadOnly\\"
        },
        poweruser: {
          Policy: \\"arn:aws:iam::aws:policy/AmazonEC2ContainerRegistryPowerUser\\"
        },
        full: {
          Policy: \\"arn:aws:iam::aws:policy/AmazonEC2ContainerRegistryFullAccess\\"
        }
      }
    });

    new cdk.CfnMapping(this, \\"MetricsLambdaBucket\\", {
      mapping: {
        \\"us-east-1\\": { Bucket: \\"buildkite-metrics\\" },
        \\"us-east-2\\": { Bucket: \\"buildkite-metrics-us-east-2\\" },
        \\"us-west-1\\": { Bucket: \\"buildkite-metrics-us-west-1\\" },
        \\"us-west-2\\": { Bucket: \\"buildkite-metrics-us-west-2\\" },
        \\"eu-west-1\\": { Bucket: \\"buildkite-metrics-eu-west-1\\" },
        \\"eu-west-2\\": { Bucket: \\"buildkite-metrics-eu-west-2\\" },
        \\"eu-central-1\\": { Bucket: \\"buildkite-metrics-eu-central-1\\" },
        \\"ap-northeast-1\\": { Bucket: \\"buildkite-metrics-ap-northeast-1\\" },
        \\"ap-northeast-2\\": { Bucket: \\"buildkite-metrics-ap-northeast-2\\" },
        \\"ap-southeast-1\\": { Bucket: \\"buildkite-metrics-ap-southeast-1\\" },
        \\"ap-southeast-2\\": { Bucket: \\"buildkite-metrics-ap-southeast-2\\" },
        \\"ap-south-1\\": { Bucket: \\"buildkite-metrics-ap-south-1\\" },
        \\"sa-east-1\\": { Bucket: \\"buildkite-metrics-sa-east-1\\" }
      }
    });

    new cdk.CfnMapping(this, \\"AWSRegion2AMI\\", {
      mapping: {
        \\"us-east-1\\": { AMI: \\"ami-08361b08a1bdc52ce\\" },
        \\"us-east-2\\": { AMI: \\"ami-0de84efc5bd5d8f45\\" },
        \\"us-west-1\\": { AMI: \\"ami-0d7b8f53098f0832e\\" },
        \\"us-west-2\\": { AMI: \\"ami-024906a3f49a723c0\\" },
        \\"eu-west-1\\": { AMI: \\"ami-081315bd246893405\\" },
        \\"eu-west-2\\": { AMI: \\"ami-0d8ad4c20a873b867\\" },
        \\"eu-central-1\\": { AMI: \\"ami-03889b1fc23df65d7\\" },
        \\"ap-northeast-1\\": { AMI: \\"ami-07e9586052fa7e87b\\" },
        \\"ap-northeast-2\\": { AMI: \\"ami-0846198638b500217\\" },
        \\"ap-southeast-1\\": { AMI: \\"ami-0a298ef89b00a97b9\\" },
        \\"ap-southeast-2\\": { AMI: \\"ami-0a541d0604bff3890\\" },
        \\"ap-south-1\\": { AMI: \\"ami-0283d0ab170de1f81\\" },
        \\"sa-east-1\\": { AMI: \\"ami-06e329498e6ae405b\\" }
      }
    });

    const useSpotInstances = new cdk.CfnCondition(this, \\"UseSpotInstances\\", {
      expression: cdk.Fn.conditionNot(
        cdk.Fn.conditionEquals(spotPrice.value as any, 0)
      )
    });

    const createVpcResources = new cdk.CfnCondition(
      this,
      \\"CreateVpcResources\\",
      { expression: cdk.Fn.conditionEquals(vpcId.value as any, \\"\\") }
    );

    const createSecurityGroup = new cdk.CfnCondition(
      this,
      \\"CreateSecurityGroup\\",
      { expression: cdk.Fn.conditionEquals(securityGroupId.value as any, \\"\\") }
    );

    const createSecretsBucket = new cdk.CfnCondition(
      this,
      \\"CreateSecretsBucket\\",
      { expression: cdk.Fn.conditionEquals(secretsBucket.value as any, \\"\\") }
    );

    const setInstanceRoleName = new cdk.CfnCondition(
      this,
      \\"SetInstanceRoleName\\",
      {
        expression: cdk.Fn.conditionNot(
          cdk.Fn.conditionEquals(instanceRoleName.value as any, \\"\\")
        )
      }
    );

    const useSpecifiedSecretsBucket = new cdk.CfnCondition(
      this,
      \\"UseSpecifiedSecretsBucket\\",
      {
        expression: cdk.Fn.conditionNot(
          cdk.Fn.conditionEquals(secretsBucket.value as any, \\"\\")
        )
      }
    );

    const useSpecifiedAvailabilityZones = new cdk.CfnCondition(
      this,
      \\"UseSpecifiedAvailabilityZones\\",
      {
        expression: cdk.Fn.conditionNot(
          cdk.Fn.conditionEquals(
            cdk.Fn.join(\\"\\", availabilityZones.value as any),
            \\"\\"
          )
        )
      }
    );

    const useArtifactsBucket = new cdk.CfnCondition(
      this,
      \\"UseArtifactsBucket\\",
      {
        expression: cdk.Fn.conditionNot(
          cdk.Fn.conditionEquals(artifactsBucket.value as any, \\"\\")
        )
      }
    );

    const useDefaultAmi = new cdk.CfnCondition(this, \\"UseDefaultAMI\\", {
      expression: cdk.Fn.conditionEquals(imageId.value as any, \\"\\")
    });

    const useManagedPolicyArn = new cdk.CfnCondition(
      this,
      \\"UseManagedPolicyARN\\",
      {
        expression: cdk.Fn.conditionNot(
          cdk.Fn.conditionEquals(
            cdk.Fn.join(\\"\\", managedPolicyArn.value as any),
            \\"\\"
          )
        )
      }
    );

    const useEcr = new cdk.CfnCondition(this, \\"UseECR\\", {
      expression: cdk.Fn.conditionNot(
        cdk.Fn.conditionEquals(ecrAccessPolicy.value as any, \\"none\\")
      )
    });

    const useAutoscaling = new cdk.CfnCondition(this, \\"UseAutoscaling\\", {
      expression: cdk.Fn.conditionNot(
        cdk.Fn.conditionEquals(maxSize.value as any, minSize.value as any)
      )
    });

    const createMetricsStack = new cdk.CfnCondition(
      this,
      \\"CreateMetricsStack\\",
      { expression: useAutoscaling }
    );

    const useCostAllocationTags = new cdk.CfnCondition(
      this,
      \\"UseCostAllocationTags\\",
      {
        expression: cdk.Fn.conditionEquals(
          enableCostAllocationTags.value as any,
          \\"true\\"
        )
      }
    );

    const hasKeyName = new cdk.CfnCondition(this, \\"HasKeyName\\", {
      expression: cdk.Fn.conditionNot(
        cdk.Fn.conditionEquals(keyName.value as any, \\"\\")
      )
    });

    const enableSshIngress = new cdk.CfnCondition(this, \\"EnableSshIngress\\", {
      expression: cdk.Fn.conditionAnd(
        createSecurityGroup,
        cdk.Fn.conditionOr(
          hasKeyName,
          cdk.Fn.conditionNot(
            cdk.Fn.conditionEquals(authorizedUsersUrl.value as any, \\"\\")
          )
        )
      )
    });

    const hasManagedPolicies = new cdk.CfnCondition(
      this,
      \\"HasManagedPolicies\\",
      { expression: cdk.Fn.conditionOr(useManagedPolicyArn, useEcr) }
    );

    const lambdaExecutionRole = new iam.CfnRole(this, \\"LambdaExecutionRole\\", {
      assumeRolePolicyDocument: {
        Version: \\"2012-10-17\\",
        Statement: [
          {
            Effect: \\"Allow\\",
            Principal: { Service: [\\"lambda.amazonaws.com\\"] },
            Action: [\\"sts:AssumeRole\\"]
          }
        ]
      },
      path: \\"/\\"
    });
    lambdaExecutionRole.cfnOptions.condition = createMetricsStack;

    const lambdaExecutionPolicy = new iam.CfnPolicy(
      this,
      \\"LambdaExecutionPolicy\\",
      {
        policyName: \\"AccessToCloudwatchForBuildkiteMetrics\\",
        roles: [lambdaExecutionRole.ref],
        policyDocument: {
          Version: \\"2012-10-17\\",
          Statement: [
            {
              Effect: \\"Allow\\",
              Action: [
                \\"logs:CreateLogGroup\\",
                \\"logs:CreateLogStream\\",
                \\"logs:PutLogEvents\\",
                \\"cloudwatch:PutMetricData\\"
              ],
              Resource: [\\"*\\"]
            }
          ]
        }
      }
    );
    lambdaExecutionPolicy.cfnOptions.condition = createMetricsStack;

    const buildkiteMetricsFunction = new lambda.CfnFunction(
      this,
      \\"BuildkiteMetricsFunction\\",
      {
        code: {
          s3Bucket: cdk.Fn.findInMap(
            \\"MetricsLambdaBucket\\",
            cdk.Aws.REGION,
            \\"Bucket\\"
          ),
          s3Key: \\"buildkite-metrics-v3.0.0-lambda.zip\\"
        },
        role: lambdaExecutionRole.attrArn,
        timeout: 120,
        handler: \\"handler.handle\\",
        runtime: \\"python2.7\\",
        memorySize: 128,
        environment: {
          variables: {
            BUILDKITE_AGENT_TOKEN: buildkiteAgentToken.value as any,
            BUILDKITE_QUEUE: buildkiteQueue.value as any,
            AWS_STACK_ID: cdk.Aws.STACK_ID,
            AWS_STACK_NAME: cdk.Aws.STACK_NAME,
            AWS_ACCOUNT_ID: cdk.Aws.ACCOUNT_ID
          }
        }
      }
    );
    buildkiteMetricsFunction.cfnOptions.condition = createMetricsStack;
    buildkiteMetricsFunction.addDependsOn(lambdaExecutionPolicy);

    const scheduledRule = new events.CfnRule(this, \\"ScheduledRule\\", {
      description: \\"ScheduledRule\\",
      scheduleExpression: \\"rate(1 minute)\\",
      state: \\"ENABLED\\",
      targets: [
        {
          arn: buildkiteMetricsFunction.attrArn,
          id: \\"TargetBuildkiteMetricsFunction\\"
        }
      ]
    });
    scheduledRule.cfnOptions.condition = createMetricsStack;

    const permissionForEventsToInvokeLambda = new lambda.CfnPermission(
      this,
      \\"PermissionForEventsToInvokeLambda\\",
      {
        functionName: buildkiteMetricsFunction.ref,
        action: \\"lambda:InvokeFunction\\",
        principal: \\"events.amazonaws.com\\",
        sourceArn: scheduledRule.attrArn
      }
    );
    permissionForEventsToInvokeLambda.cfnOptions.condition = createMetricsStack;

    const managedSecretsLoggingBucket = new s3.CfnBucket(
      this,
      \\"ManagedSecretsLoggingBucket\\",
      { accessControl: \\"LogDeliveryWrite\\" }
    );
    managedSecretsLoggingBucket.cfnOptions.deletionPolicy =
      cdk.CfnDeletionPolicy.RETAIN;
    managedSecretsLoggingBucket.cfnOptions.condition = createSecretsBucket;

    const managedSecretsBucket = new s3.CfnBucket(
      this,
      \\"ManagedSecretsBucket\\",
      {
        loggingConfiguration: {
          destinationBucketName: managedSecretsLoggingBucket.ref
        },
        versioningConfiguration: { status: \\"Enabled\\" }
      }
    );
    managedSecretsBucket.cfnOptions.deletionPolicy =
      cdk.CfnDeletionPolicy.RETAIN;
    managedSecretsBucket.cfnOptions.condition = createSecretsBucket;

    const iamRole = new iam.CfnRole(this, \\"IAMRole\\", {
      roleName: cdk.Fn.conditionIf(
        \\"SetInstanceRoleName\\",
        instanceRoleName.value as any,
        cdk.Fn.sub(\\"\${AWS::StackName}-Role\\")
      ),
      managedPolicyArns: cdk.Fn.conditionIf(
        \\"HasManagedPolicies\\",
        cdk.Fn.split(
          \\",\\",
          cdk.Fn.join(\\",\\", [
            cdk.Fn.conditionIf(
              \\"UseECR\\",
              cdk.Fn.findInMap(
                \\"ECRManagedPolicy\\",
                ecrAccessPolicy.value as any,
                \\"Policy\\"
              ),
              cdk.Aws.NO_VALUE
            ),
            cdk.Fn.conditionIf(
              \\"UseManagedPolicyARN\\",
              cdk.Fn.join(\\",\\", managedPolicyArn.value as any),
              cdk.Aws.NO_VALUE
            )
          ])
        ),
        cdk.Aws.NO_VALUE
      ),
      assumeRolePolicyDocument: {
        Statement: [
          {
            Effect: \\"Allow\\",
            Principal: {
              Service: [\\"autoscaling.amazonaws.com\\", \\"ec2.amazonaws.com\\"]
            },
            Action: \\"sts:AssumeRole\\"
          }
        ]
      },
      path: \\"/\\"
    });

    const iamInstanceProfile = new iam.CfnInstanceProfile(
      this,
      \\"IAMInstanceProfile\\",
      { path: \\"/\\", roles: [iamRole.ref] }
    );

    const vpc = new ec2.CfnVPC(this, \\"Vpc\\", {
      cidrBlock: \\"10.0.0.0/16\\",
      instanceTenancy: \\"default\\",
      tags: [{ key: \\"Name\\", value: cdk.Aws.STACK_NAME }]
    });
    vpc.cfnOptions.condition = createVpcResources;

    const securityGroup = new ec2.CfnSecurityGroup(this, \\"SecurityGroup\\", {
      groupDescription: \\"Enable access to agents\\",
      vpcId: cdk.Fn.conditionIf(
        \\"CreateVpcResources\\",
        vpc.ref,
        vpcId.value as any
      ),
      tags: [{ key: \\"Name\\", value: cdk.Aws.STACK_NAME }]
    });
    securityGroup.cfnOptions.condition = createSecurityGroup;

    const agentLaunchConfiguration = new autoscaling.CfnLaunchConfiguration(
      this,
      \\"AgentLaunchConfiguration\\",
      {
        associatePublicIpAddress: associatePublicIpAddress.value as any,
        securityGroups: [
          cdk.Fn.conditionIf(
            \\"CreateSecurityGroup\\",
            securityGroup.ref,
            securityGroupId.value as any
          )
        ],
        keyName: cdk.Fn.conditionIf(
          \\"HasKeyName\\",
          keyName.value as any,
          cdk.Aws.NO_VALUE
        ),
        iamInstanceProfile: iamInstanceProfile.ref,
        instanceType: instanceType.value as any,
        spotPrice: cdk.Fn.conditionIf(
          \\"UseSpotInstances\\",
          spotPrice.value as any,
          cdk.Aws.NO_VALUE
        ),
        imageId: cdk.Fn.conditionIf(
          \\"UseDefaultAMI\\",
          cdk.Fn.findInMap(\\"AWSRegion2AMI\\", cdk.Aws.REGION, \\"AMI\\"),
          imageId.value as any
        ),
        blockDeviceMappings: [
          {
            deviceName: \\"/dev/xvda\\",
            ebs: { volumeSize: rootVolumeSize.value as any, volumeType: \\"gp2\\" }
          }
        ],
        userData: cdk.Fn.base64(
          cdk.Fn.sub(
            'Content-Type: multipart/mixed; boundary=\\"==BOUNDARY==\\"\\\\nMIME-Version: 1.0\\\\n--==BOUNDARY==\\\\nContent-Type: text/cloud-boothook; charset=\\"us-ascii\\"\\\\nDOCKER_USERNS_REMAP=\${EnableDockerUserNamespaceRemap} \\\\\\\\\\\\nDOCKER_EXPERIMENTAL=\${EnableDockerExperimental} \\\\\\\\\\\\n  /usr/local/bin/bk-configure-docker.sh\\\\n\\\\n--==BOUNDARY==\\\\nContent-Type: text/x-shellscript; charset=\\"us-ascii\\"\\\\n#!/bin/bash -xv\\\\nBUILDKITE_STACK_NAME=\\"\${AWS::StackName}\\" \\\\\\\\\\\\nBUILDKITE_STACK_VERSION=v4.0.2 \\\\\\\\\\\\nBUILDKITE_SECRETS_BUCKET=\\"\${LocalSecretsBucket}\\" \\\\\\\\\\\\nBUILDKITE_AGENT_TOKEN=\\"\${BuildkiteAgentToken}\\" \\\\\\\\\\\\nBUILDKITE_AGENTS_PER_INSTANCE=\\"\${AgentsPerInstance}\\" \\\\\\\\\\\\nBUILDKITE_AGENT_TAGS=\\"\${BuildkiteAgentTags}\\" \\\\\\\\\\\\nBUILDKITE_AGENT_TIMESTAMP_LINES=\\"\${BuildkiteAgentTimestampLines}\\" \\\\\\\\\\\\nBUILDKITE_AGENT_EXPERIMENTS=\\"\${BuildkiteAgentExperiments}\\" \\\\\\\\\\\\nBUILDKITE_AGENT_RELEASE=\\"\${BuildkiteAgentRelease}\\" \\\\\\\\\\\\nBUILDKITE_QUEUE=\\"\${BuildkiteQueue}\\" \\\\\\\\\\\\nBUILDKITE_ELASTIC_BOOTSTRAP_SCRIPT=\\"\${BootstrapScriptUrl}\\" \\\\\\\\\\\\nBUILDKITE_AUTHORIZED_USERS_URL=\\"\${AuthorizedUsersUrl}\\" \\\\\\\\\\\\nBUILDKITE_ECR_POLICY=\${ECRAccessPolicy} \\\\\\\\\\\\nBUILDKITE_LIFECYCLE_TOPIC=\${AgentLifecycleTopic} \\\\\\\\\\\\nAWS_DEFAULT_REGION=\${AWS::Region} \\\\\\\\\\\\nSECRETS_PLUGIN_ENABLED=\${EnableSecretsPlugin} \\\\\\\\\\\\nECR_PLUGIN_ENABLED=\${EnableECRPlugin} \\\\\\\\\\\\nDOCKER_LOGIN_PLUGIN_ENABLED=\${EnableDockerLoginPlugin} \\\\\\\\\\\\nAWS_REGION=\${AWS::Region} \\\\\\\\\\\\n  /usr/local/bin/bk-install-elastic-stack.sh\\\\n--==BOUNDARY==--\\\\n',
            {
              LocalSecretsBucket: cdk.Fn.conditionIf(
                \\"CreateSecretsBucket\\",
                managedSecretsBucket.ref,
                secretsBucket.value as any
              )
            }
          )
        )
      }
    );

    const subnet1 = new ec2.CfnSubnet(this, \\"Subnet1\\", {
      availabilityZone: cdk.Fn.conditionIf(
        \\"UseSpecifiedAvailabilityZones\\",
        cdk.Fn.select(1, availabilityZones.value as any),
        cdk.Fn.select(1, cdk.Fn.getAzs(\\"\\"))
      ),
      cidrBlock: \\"10.0.2.0/24\\",
      vpcId: vpc.ref,
      tags: [{ key: \\"Name\\", value: cdk.Aws.STACK_NAME }]
    });
    subnet1.cfnOptions.condition = createVpcResources;

    const subnet0 = new ec2.CfnSubnet(this, \\"Subnet0\\", {
      availabilityZone: cdk.Fn.conditionIf(
        \\"UseSpecifiedAvailabilityZones\\",
        cdk.Fn.select(0, availabilityZones.value as any),
        cdk.Fn.select(0, cdk.Fn.getAzs(\\"\\"))
      ),
      cidrBlock: \\"10.0.1.0/24\\",
      vpcId: vpc.ref,
      tags: [{ key: \\"Name\\", value: cdk.Aws.STACK_NAME }]
    });
    subnet0.cfnOptions.condition = createVpcResources;

    const agentAutoScaleGroup = new autoscaling.CfnAutoScalingGroup(
      this,
      \\"AgentAutoScaleGroup\\",
      {
        vpcZoneIdentifier: cdk.Fn.conditionIf(
          \\"CreateVpcResources\\",
          [subnet0.ref, subnet1.ref],
          subnets.value as any
        ),
        launchConfigurationName: agentLaunchConfiguration.ref,
        minSize: minSize.value as any,
        maxSize: maxSize.value as any,
        metricsCollection: [
          {
            granularity: \\"1Minute\\",
            metrics: [
              \\"GroupMinSize\\",
              \\"GroupMaxSize\\",
              \\"GroupInServiceInstances\\",
              \\"GroupTerminatingInstances\\",
              \\"GroupPendingInstances\\"
            ]
          }
        ],
        terminationPolicies: [
          \\"OldestLaunchConfiguration\\",
          \\"ClosestToNextInstanceHour\\"
        ],
        tags: [
          { key: \\"Role\\", value: \\"buildkite-agent\\", propagateAtLaunch: true },
          { key: \\"Name\\", value: \\"buildkite-agent\\", propagateAtLaunch: true },
          {
            key: \\"BuildkiteAgentRelease\\",
            value: buildkiteAgentRelease.value as any,
            propagateAtLaunch: true
          },
          {
            key: \\"BuildkiteQueue\\",
            value: buildkiteQueue.value as any,
            propagateAtLaunch: true
          }
        ]
      }
    );
    agentAutoScaleGroup.cfnOptions.creationPolicy = {
      resourceSignal: {
        timeout: instanceCreationTimeout.value as any,
        count: minSize.value as any
      }
    };
    agentAutoScaleGroup.cfnOptions.updatePolicy = {
      autoScalingReplacingUpdate: { willReplace: true }
    };

    const agentScaleDownPolicy = new autoscaling.CfnScalingPolicy(
      this,
      \\"AgentScaleDownPolicy\\",
      {
        adjustmentType: \\"ChangeInCapacity\\",
        autoScalingGroupName: agentAutoScaleGroup.ref,
        cooldown: \\"300\\",
        scalingAdjustment: scaleDownAdjustment.value as any
      }
    );
    agentScaleDownPolicy.cfnOptions.condition = useAutoscaling;

    const agentUtilizationAlarmLow = new cloudwatch.CfnAlarm(
      this,
      \\"AgentUtilizationAlarmLow\\",
      {
        alarmDescription: \\"Scale-down if UnfinishedJobs == 0 for N minutes\\",
        metricName: \\"UnfinishedJobsCount\\",
        namespace: \\"Buildkite\\",
        statistic: \\"Maximum\\",
        period: scaleDownPeriod.value as any,
        evaluationPeriods: 1,
        threshold: 0,
        alarmActions: [agentScaleDownPolicy.ref],
        dimensions: [{ name: \\"Queue\\", value: buildkiteQueue.value as any }],
        comparisonOperator: \\"LessThanOrEqualToThreshold\\"
      }
    );
    agentUtilizationAlarmLow.cfnOptions.condition = useAutoscaling;

    const agentScaleUpPolicy = new autoscaling.CfnScalingPolicy(
      this,
      \\"AgentScaleUpPolicy\\",
      {
        adjustmentType: \\"ChangeInCapacity\\",
        autoScalingGroupName: agentAutoScaleGroup.ref,
        cooldown: \\"300\\",
        scalingAdjustment: scaleUpAdjustment.value as any
      }
    );
    agentScaleUpPolicy.cfnOptions.condition = useAutoscaling;

    const agentUtilizationAlarmHigh = new cloudwatch.CfnAlarm(
      this,
      \\"AgentUtilizationAlarmHigh\\",
      {
        alarmDescription: \\"Scale-up if ScheduledJobs > 0 for 1 minute\\",
        metricName: \\"ScheduledJobsCount\\",
        namespace: \\"Buildkite\\",
        statistic: \\"Minimum\\",
        period: 60,
        evaluationPeriods: 1,
        threshold: 0,
        alarmActions: [agentScaleUpPolicy.ref],
        dimensions: [{ name: \\"Queue\\", value: buildkiteQueue.value as any }],
        comparisonOperator: \\"GreaterThanThreshold\\"
      }
    );
    agentUtilizationAlarmHigh.cfnOptions.condition = useAutoscaling;

    const securityGroupSshIngress = new ec2.CfnSecurityGroupIngress(
      this,
      \\"SecurityGroupSshIngress\\",
      {
        groupId: securityGroup.attrGroupId,
        ipProtocol: \\"tcp\\",
        fromPort: 22,
        toPort: 22,
        cidrIp: \\"0.0.0.0/0\\"
      }
    );
    securityGroupSshIngress.cfnOptions.condition = enableSshIngress;

    const agentLifecycleTopic = new sns.CfnTopic(
      this,
      \\"AgentLifecycleTopic\\",
      {}
    );

    const agentLifecycleHookRole = new iam.CfnRole(
      this,
      \\"AgentLifecycleHookRole\\",
      {
        assumeRolePolicyDocument: {
          Statement: [
            {
              Effect: \\"Allow\\",
              Principal: { Service: [\\"autoscaling.amazonaws.com\\"] },
              Action: \\"sts:AssumeRole\\"
            }
          ]
        },
        policies: [
          {
            policyName: \\"AgentLifecyclePolicy\\",
            policyDocument: {
              Statement: [
                {
                  Effect: \\"Allow\\",
                  Action: [\\"sns:Publish\\"],
                  Resource: agentLifecycleTopic.ref
                }
              ]
            }
          }
        ],
        path: \\"/\\"
      }
    );

    const agentLifecycleHook = new autoscaling.CfnLifecycleHook(
      this,
      \\"AgentLifecycleHook\\",
      {
        autoScalingGroupName: agentAutoScaleGroup.ref,
        lifecycleTransition: \\"autoscaling:EC2_INSTANCE_TERMINATING\\",
        defaultResult: \\"CONTINUE\\",
        heartbeatTimeout: 120,
        notificationTargetArn: agentLifecycleTopic.ref,
        roleArn: agentLifecycleHookRole.attrArn
      }
    );

    const artifactsBucketPolicies = new iam.CfnPolicy(
      this,
      \\"ArtifactsBucketPolicies\\",
      {
        policyName: \\"ArtifactsBucketPolicy\\",
        policyDocument: {
          Statement: [
            {
              Effect: \\"Allow\\",
              Action: [\\"s3:Put*\\", \\"s3:List*\\", \\"s3:Get*\\"],
              Resource: [
                cdk.Fn.sub(\\"arn:aws:s3:::\${ArtifactsBucket}/*\\"),
                cdk.Fn.sub(\\"arn:aws:s3:::\${ArtifactsBucket}\\")
              ]
            }
          ]
        },
        roles: [iamRole.ref]
      }
    );
    artifactsBucketPolicies.cfnOptions.condition = useArtifactsBucket;

    const unmanagedSecretsBucketPolicy = new iam.CfnPolicy(
      this,
      \\"UnmanagedSecretsBucketPolicy\\",
      {
        policyName: \\"SecretsBucketPolicy\\",
        policyDocument: {
          Statement: [
            {
              Effect: \\"Allow\\",
              Action: [\\"s3:Get*\\", \\"s3:Get\\", \\"s3:List*\\"],
              Resource: [
                cdk.Fn.sub(\\"arn:aws:s3:::\${SecretsBucket}/*\\"),
                cdk.Fn.sub(\\"arn:aws:s3:::\${SecretsBucket}\\")
              ]
            }
          ]
        },
        roles: [iamRole.ref]
      }
    );
    unmanagedSecretsBucketPolicy.cfnOptions.condition = useSpecifiedSecretsBucket;

    const managedSecretsBucketPolicy = new iam.CfnPolicy(
      this,
      \\"ManagedSecretsBucketPolicy\\",
      {
        policyName: \\"SecretsBucketPolicy\\",
        policyDocument: {
          Statement: [
            {
              Effect: \\"Allow\\",
              Action: [\\"s3:Get*\\", \\"s3:Get\\", \\"s3:List*\\"],
              Resource: [
                cdk.Fn.sub(\\"arn:aws:s3:::\${ManagedSecretsBucket}/*\\"),
                cdk.Fn.sub(\\"arn:aws:s3:::\${ManagedSecretsBucket}\\")
              ]
            }
          ]
        },
        roles: [iamRole.ref]
      }
    );
    managedSecretsBucketPolicy.cfnOptions.condition = createSecretsBucket;

    const iamPolicies = new iam.CfnPolicy(this, \\"IAMPolicies\\", {
      policyName: \\"InstancePolicy\\",
      policyDocument: {
        Statement: [
          {
            Effect: \\"Allow\\",
            Action: [
              \\"cloudwatch:PutMetricData\\",
              \\"cloudformation:DescribeStackResource\\",
              \\"ec2:DescribeTags\\",
              \\"autoscaling:DescribeAutoScalingInstances\\",
              \\"autoscaling:DescribeLifecycleHooks\\",
              \\"autoscaling:RecordLifecycleActionHeartbeat\\",
              \\"autoscaling:CompleteLifecycleAction\\",
              \\"autoscaling:SetInstanceHealth\\"
            ],
            Resource: \\"*\\"
          },
          {
            Effect: \\"Allow\\",
            Action: [
              \\"logs:CreateLogGroup\\",
              \\"logs:CreateLogStream\\",
              \\"logs:PutLogEvents\\",
              \\"logs:DescribeLogStreams\\"
            ],
            Resource: \\"*\\"
          },
          {
            Effect: \\"Allow\\",
            Action: [\\"sqs:*\\", \\"sns:Unsubscribe\\", \\"sns:Subscribe\\"],
            Resource: \\"*\\"
          }
        ]
      },
      roles: [iamRole.ref]
    });

    const routes = new ec2.CfnRouteTable(this, \\"Routes\\", {
      vpcId: vpc.ref,
      tags: [{ key: \\"Name\\", value: cdk.Aws.STACK_NAME }]
    });
    routes.cfnOptions.condition = createVpcResources;

    const subnet1Routes = new ec2.CfnSubnetRouteTableAssociation(
      this,
      \\"Subnet1Routes\\",
      { subnetId: subnet1.ref, routeTableId: routes.ref }
    );
    subnet1Routes.cfnOptions.condition = createVpcResources;

    const subnet0Routes = new ec2.CfnSubnetRouteTableAssociation(
      this,
      \\"Subnet0Routes\\",
      { subnetId: subnet0.ref, routeTableId: routes.ref }
    );
    subnet0Routes.cfnOptions.condition = createVpcResources;

    const gateway = new ec2.CfnInternetGateway(this, \\"Gateway\\", {
      tags: [{ key: \\"Name\\", value: cdk.Aws.STACK_NAME }]
    });
    gateway.cfnOptions.condition = createVpcResources;

    const gatewayAttachment = new ec2.CfnVPCGatewayAttachment(
      this,
      \\"GatewayAttachment\\",
      { internetGatewayId: gateway.ref, vpcId: vpc.ref }
    );
    gatewayAttachment.cfnOptions.condition = createVpcResources;

    const routeDefault = new ec2.CfnRoute(this, \\"RouteDefault\\", {
      destinationCidrBlock: \\"0.0.0.0/0\\",
      gatewayId: gateway.ref,
      routeTableId: routes.ref
    });
    routeDefault.cfnOptions.condition = createVpcResources;
    routeDefault.addDependsOn(gatewayAttachment);

    new cdk.CfnOutput(this, \\"ManagedSecretsBucket\\", {
      value: cdk.Fn.conditionIf(
        \\"CreateSecretsBucket\\",
        managedSecretsBucket.ref,
        \\"\\"
      )
    });

    new cdk.CfnOutput(this, \\"ManagedSecretsLoggingBucket\\", {
      value: cdk.Fn.conditionIf(
        \\"CreateSecretsBucket\\",
        managedSecretsLoggingBucket.ref,
        \\"\\"
      )
    });

    new cdk.CfnOutput(this, \\"AutoScalingGroupName\\", {
      value: agentAutoScaleGroup.ref
    });

    new cdk.CfnOutput(this, \\"InstanceRoleName\\", { value: iamRole.ref });
  }
}
"
`;

exports[`Stack ./examples/buildkiteasg.json compiles to ./examples/tmp/buildkiteasg.ts 1`] = `
"import * as cdk from \\"@aws-cdk/core\\";
import * as autoscaling from \\"@aws-cdk/aws-autoscaling\\";

export class BuildkiteasgStack extends cdk.Stack {
  constructor(parent: cdk.App, id: string, props?: cdk.StackProps) {
    super(parent, id, props);

    const subnets = new cdk.CfnParameter(this, \\"Subnets\\", {
      type: \\"CommaDelimitedList\\",
      description:
        \\"Optional - Comma separated list of two existing VPC subnet ids where EC2 instances will run. Required if setting VpcId.\\",
      default: \\"\\"
    });

    const maxSize = new cdk.CfnParameter(this, \\"MaxSize\\", {
      description: \\"Maximum number of instances\\",
      type: \\"Number\\",
      default: 10,
      minValue: 1
    });

    const minSize = new cdk.CfnParameter(this, \\"MinSize\\", {
      description: \\"Minimum number of instances\\",
      type: \\"Number\\",
      default: 0
    });

    const buildkiteAgentRelease = new cdk.CfnParameter(
      this,
      \\"BuildkiteAgentRelease\\",
      {
        type: \\"String\\",
        allowedValues: [\\"stable\\", \\"beta\\", \\"edge\\"],
        default: \\"stable\\"
      }
    );

    const buildkiteQueue = new cdk.CfnParameter(this, \\"BuildkiteQueue\\", {
      description:
        'Queue name that agents will use, targeted in pipeline steps using \\"queue={value}\\"',
      type: \\"String\\",
      default: \\"default\\",
      minLength: 1
    });

    const costAllocationTagName = new cdk.CfnParameter(
      this,
      \\"CostAllocationTagName\\",
      {
        type: \\"String\\",
        description:
          \\"The name of the Cost Allocation Tag used for billing purposes\\",
        default: \\"aws:createdBy\\"
      }
    );

    const costAllocationTagValue = new cdk.CfnParameter(
      this,
      \\"CostAllocationTagValue\\",
      {
        type: \\"String\\",
        description:
          \\"The value of the Cost Allocation Tag used for billing purposes\\",
        default: \\"buildkite-elastic-ci-stack-for-aws\\"
      }
    );

    const instanceCreationTimeout = new cdk.CfnParameter(
      this,
      \\"InstanceCreationTimeout\\",
      {
        description: \\"Timeout period for Autoscaling Group Creation Policy\\",
        type: \\"String\\",
        default: \\"PT5M\\"
      }
    );

    const agentLaunchConfiguration = new autoscaling.CfnLaunchConfiguration(
      this,
      \\"AgentLaunchConfiguration\\",
      { imageId: \\"ami-fff\\", instanceType: \\"m4.large\\" }
    );

    const agentAutoScaleGroup = new autoscaling.CfnAutoScalingGroup(
      this,
      \\"AgentAutoScaleGroup\\",
      {
        vpcZoneIdentifier: [subnets.value as any],
        launchConfigurationName: agentLaunchConfiguration.ref,
        minSize: minSize.value as any,
        maxSize: maxSize.value as any,
        metricsCollection: [
          {
            granularity: \\"1Minute\\",
            metrics: [
              \\"GroupMinSize\\",
              \\"GroupMaxSize\\",
              \\"GroupInServiceInstances\\",
              \\"GroupTerminatingInstances\\",
              \\"GroupPendingInstances\\"
            ]
          }
        ],
        terminationPolicies: [
          \\"OldestLaunchConfiguration\\",
          \\"ClosestToNextInstanceHour\\"
        ],
        tags: [
          { key: \\"Role\\", value: \\"buildkite-agent\\", propagateAtLaunch: true },
          { key: \\"Name\\", value: \\"buildkite-agent\\", propagateAtLaunch: true },
          {
            key: \\"BuildkiteAgentRelease\\",
            value: buildkiteAgentRelease.value as any,
            propagateAtLaunch: true
          },
          {
            key: \\"BuildkiteQueue\\",
            value: buildkiteQueue.value as any,
            propagateAtLaunch: true
          }
        ]
      }
    );
    agentAutoScaleGroup.cfnOptions.creationPolicy = {
      resourceSignal: {
        timeout: instanceCreationTimeout.value as any,
        count: minSize.value as any
      }
    };
    agentAutoScaleGroup.cfnOptions.updatePolicy = {
      autoScalingReplacingUpdate: { willReplace: true }
    };
  }
}
"
`;

exports[`Stack ./examples/cloudtrail.json compiles to ./examples/tmp/cloudtrail.ts 1`] = `
"import * as cdk from \\"@aws-cdk/core\\";
import * as cloudtrail from \\"@aws-cdk/aws-cloudtrail\\";

export class CloudtrailStack extends cdk.Stack {
  constructor(parent: cdk.App, id: string, props?: cdk.StackProps) {
    super(parent, id, props);

    const loggingBucket = new cdk.CfnParameter(this, \\"LoggingBucket\\", {
      description: \\"The name of the bucket to send cloudtrail logs to\\",
      type: \\"String\\"
    });

    const unused = new cdk.CfnParameter(this, \\"Unused\\", {
      description: \\"An unused parameter to test ref checks\\",
      type: \\"String\\"
    });

    const cloudTrail = new cloudtrail.CfnTrail(this, \\"CloudTrail\\", {
      isLogging: true,
      isMultiRegionTrail: true,
      includeGlobalServiceEvents: true,
      s3BucketName: loggingBucket.value as any,
      s3KeyPrefix: \\"cloudtrails\\"
    });
  }
}
"
`;

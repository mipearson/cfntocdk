{
  "Parameters": {
    "Subnets": {
      "Type": "CommaDelimitedList",
      "Description": "Optional - Comma separated list of two existing VPC subnet ids where EC2 instances will run. Required if setting VpcId.",
      "Default": ""
    },
    "MaxSize": {
      "Description": "Maximum number of instances",
      "Type": "Number",
      "Default": 10,
      "MinValue": 1
    },
    "MinSize": {
      "Description": "Minimum number of instances",
      "Type": "Number",
      "Default": 0
    },
    "BuildkiteAgentRelease": {
      "Type": "String",
      "AllowedValues": ["stable", "beta", "edge"],
      "Default": "stable"
    },
    "BuildkiteQueue": {
      "Description": "Queue name that agents will use, targeted in pipeline steps using \"queue={value}\"",
      "Type": "String",
      "Default": "default",
      "MinLength": 1
    },
    "CostAllocationTagName": {
      "Type": "String",
      "Description": "The name of the Cost Allocation Tag used for billing purposes",
      "Default": "aws:createdBy"
    },
    "CostAllocationTagValue": {
      "Type": "String",
      "Description": "The value of the Cost Allocation Tag used for billing purposes",
      "Default": "buildkite-elastic-ci-stack-for-aws"
    },
    "InstanceCreationTimeout": {
      "Description": "Timeout period for Autoscaling Group Creation Policy",
      "Type": "String",
      "Default": "PT5M"
    }
  },
  "Resources": {
    "AgentLaunchConfiguration": {
      "Type": "AWS::AutoScaling::LaunchConfiguration",
      "Properties": {
        "ImageId": "ami-fff",
        "InstanceType": "m4.large"
      }
    },
    "AgentAutoScaleGroup": {
      "Type": "AWS::AutoScaling::AutoScalingGroup",
      "Properties": {
        "VPCZoneIdentifier": [
          {
            "Ref": "Subnets"
          }
        ],
        "LaunchConfigurationName": {
          "Ref": "AgentLaunchConfiguration"
        },
        "MinSize": {
          "Ref": "MinSize"
        },
        "MaxSize": {
          "Ref": "MaxSize"
        },
        "MetricsCollection": [
          {
            "Granularity": "1Minute",
            "Metrics": [
              "GroupMinSize",
              "GroupMaxSize",
              "GroupInServiceInstances",
              "GroupTerminatingInstances",
              "GroupPendingInstances"
            ]
          }
        ],
        "TerminationPolicies": [
          "OldestLaunchConfiguration",
          "ClosestToNextInstanceHour"
        ],
        "Tags": [
          {
            "Key": "Role",
            "Value": "buildkite-agent",
            "PropagateAtLaunch": true
          },
          {
            "Key": "Name",
            "Value": "buildkite-agent",
            "PropagateAtLaunch": true
          },
          {
            "Key": "BuildkiteAgentRelease",
            "Value": {
              "Ref": "BuildkiteAgentRelease"
            },
            "PropagateAtLaunch": true
          },
          {
            "Key": "BuildkiteQueue",
            "Value": {
              "Ref": "BuildkiteQueue"
            },
            "PropagateAtLaunch": true
          }
        ]
      },
      "CreationPolicy": {
        "ResourceSignal": {
          "Timeout": {
            "Ref": "InstanceCreationTimeout"
          },
          "Count": {
            "Ref": "MinSize"
          }
        }
      },
      "UpdatePolicy": {
        "AutoScalingReplacingUpdate": {
          "WillReplace": true
        }
      }
    }
  }
}
